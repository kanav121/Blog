{"title":"FastAI Course Lecture 3 Notes","markdown":{"yaml":{"title":"FastAI Course Lecture 3 Notes","author":"Kanav Sharma","date":"2024-04-14","categories":["Computer Vision","FastAI"],"toc":true,"title-block-banner":true,"order":0},"headingText":"This code aims to upscale our last lession.","containsRefs":false,"markdown":"\nPreviously, we obtained our data from the DuckDuckGo API and built our model around that.\n\nThis time, we will retrieve data from a Kaggle dataset, enhance our model, improve our understanding of different available pre-trained vision architectures in PyTorch using the `timm` library, and implement another model according to our requirements.\n\n## Level 1 : Repeat last lesson\n\n### 1.1 : Download dataset from Kaggle\n\n\n```python\nfrom google.colab import files\n\n# Upload the Kaggle API key JSON file\nuploaded = files.upload()\n\n!pip install kaggle\n\n!mkdir -p ~/.kaggle\n!mv kaggle.json ~/.kaggle/\n!chmod 600 ~/.kaggle/kaggle.json\n```\n\n    Saving kaggle.json to kaggle.json\n    Requirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)\n    Requirement already satisfied: six>=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)\n    Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2024.2.2)\n    Requirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)\n    Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)\n    Requirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.2)\n    Requirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.4)\n    Requirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)\n    Requirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)\n    Requirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach->kaggle) (0.5.1)\n    Requirement already satisfied: text-unidecode>=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify->kaggle) (1.3)\n    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.3.2)\n    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.6)\n    \n\n#### Download dataset :\nOpen dataset in Kaggle, click on 3 vertical dots (ellipsis) then click on Copy API comamnd, and we are good to go.\n\n\n```python\n!kaggle datasets download -d gpiosenka/cats-in-the-wild-image-classification\n\n# Create a folder called \"Big Cat\"\n!mkdir -p Big_Cat\n\n# Unzip the dataset into the \"Big Cat\" folder\n!unzip cats-in-the-wild-image-classification.zip -d Big_Cat\n\n# Remove the zip file\n!rm cats-in-the-wild-image-classification.zip\n```\n\n    Downloading cats-in-the-wild-image-classification.zip to /content\n     96% 118M/123M [00:01<00:00, 57.4MB/s]\n    100% 123M/123M [00:01<00:00, 65.0MB/s]\n    Archive:  cats-in-the-wild-image-classification.zip\n      inflating: Big_Cat/EfficientNetB0-10-(224 X 224)-100.00.h5  \n      inflating: Big_Cat/MobileNetV3 small-10-(224 X 224)-95.96.h5  \n      inflating: Big_Cat/WILDCATS.CSV    \n      inflating: Big_Cat/test/AFRICAN LEOPARD/1.jpg  \n      inflating: Big_Cat/test/AFRICAN LEOPARD/5.jpg  \n      inflating: Big_Cat/test/CARACAL/1.jpg  \n      inflating: Big_Cat/test/CARACAL/5.jpg  \n      inflating: Big_Cat/test/CHEETAH/1.jpg  \n      inflating: Big_Cat/test/CHEETAH/5.jpg  \n      inflating: Big_Cat/test/CLOUDED LEOPARD/1.jpg  \n      inflating: Big_Cat/test/CLOUDED LEOPARD/5.jpg  \n      inflating: Big_Cat/test/JAGUAR/1.jpg  \n      inflating: Big_Cat/test/JAGUAR/5.jpg  \n      inflating: Big_Cat/test/LIONS/1.jpg  \n      inflating: Big_Cat/test/LIONS/5.jpg  \n      inflating: Big_Cat/test/OCELOT/1.jpg  \n      inflating: Big_Cat/test/OCELOT/5.jpg  \n      inflating: Big_Cat/test/PUMA/1.jpg  \n      inflating: Big_Cat/test/PUMA/5.jpg  \n      inflating: Big_Cat/test/SNOW LEOPARD/1.jpg  \n      inflating: Big_Cat/test/SNOW LEOPARD/5.jpg  \n      inflating: Big_Cat/test/TIGER/1.jpg  \n      inflating: Big_Cat/test/TIGER/5.jpg  \n      inflating: Big_Cat/train/AFRICAN LEOPARD/001.jpg  \n      inflating: Big_Cat/train/AFRICAN LEOPARD/236.jpg  \n      inflating: Big_Cat/train/CARACAL/001.jpg  \n      inflating: Big_Cat/train/CARACAL/236.jpg  \n      inflating: Big_Cat/train/CHEETAH/001.jpg  \n      inflating: Big_Cat/train/CHEETAH/235.jpg  \n      inflating: Big_Cat/train/CLOUDED LEOPARD/001.jpg  \n      inflating: Big_Cat/train/CLOUDED LEOPARD/229.jpg  \n      inflating: Big_Cat/train/JAGUAR/001.jpg  \n      inflating: Big_Cat/train/JAGUAR/238.jpg  \n      inflating: Big_Cat/train/LIONS/001.jpg  \n      inflating: Big_Cat/train/LIONS/228.jpg  \n      inflating: Big_Cat/train/OCELOT/001.jpg  \n      inflating: Big_Cat/train/OCELOT/233.jpg  \n      inflating: Big_Cat/train/PUMA/001.jpg  \n      inflating: Big_Cat/train/PUMA/236.jpg  \n      inflating: Big_Cat/train/SNOW LEOPARD/001.jpg  \n      inflating: Big_Cat/train/SNOW LEOPARD/231.jpg  \n      inflating: Big_Cat/train/TIGER/001.jpg  \n      inflating: Big_Cat/train/TIGER/237.jpg  \n      inflating: Big_Cat/valid/AFRICAN LEOPARD/1.jpg  \n      inflating: Big_Cat/valid/AFRICAN LEOPARD/5.jpg  \n      inflating: Big_Cat/valid/CARACAL/1.jpg\n      inflating: Big_Cat/valid/CARACAL/5.jpg  \n      inflating: Big_Cat/valid/CHEETAH/1.jpg  \n      inflating: Big_Cat/valid/CHEETAH/5.jpg  \n      inflating: Big_Cat/valid/CLOUDED LEOPARD/1.jpg  \n      inflating: Big_Cat/valid/CLOUDED LEOPARD/5.jpg  \n      inflating: Big_Cat/valid/JAGUAR/1.jpg  \n      inflating: Big_Cat/valid/JAGUAR/5.jpg  \n      inflating: Big_Cat/valid/LIONS/1.jpg  \n      inflating: Big_Cat/valid/LIONS/5.jpg  \n      inflating: Big_Cat/valid/OCELOT/1.jpg  \n      inflating: Big_Cat/valid/OCELOT/5.jpg  \n      inflating: Big_Cat/valid/PUMA/1.jpg  \n      inflating: Big_Cat/valid/PUMA/5.jpg  \n      inflating: Big_Cat/valid/SNOW LEOPARD/1.jpg  \n      inflating: Big_Cat/valid/SNOW LEOPARD/5.jpg  \n      inflating: Big_Cat/valid/TIGER/1.jpg  \n      inflating: Big_Cat/valid/TIGER/5.jpg  \n    \n\n#### Remove all files with the \".h5\" extension and move images from the \"valid\" folder to their corresponding subfolders in the \"train\" folder\n\n\n```python\nimport os\nimport shutil\n\n# Define the absolute paths of main, train and valid folders\nbig_cat_folder = '/content/Big_Cat/'\ntrain_folder = '/content/Big_Cat/train'\nvalid_folder = '/content/Big_Cat/valid'\n\n# Remove all files with \".h5\" extension\n!find {big_cat_folder} -type f -name '*.h5' -delete\n\n# Create a dictionary to track image counts\nimage_counts = {}\n\n# Get a list of subfolders in the train folder\ntrain_subfolders = [f.path for f in os.scandir(train_folder) if f.is_dir()]\n\n# Get a list of subfolders in the valid folder\nvalid_subfolders = [f.path for f in os.scandir(valid_folder) if f.is_dir()]\n\n# Move images from valid to their corresponding subfolders in train\nfor subfolder in valid_subfolders:\n    class_name = os.path.basename(subfolder)\n    train_subfolder = os.path.join(train_folder, class_name)\n\n    # Create the train subfolder if it doesn't exist\n    if not os.path.exists(train_subfolder):\n        os.makedirs(train_subfolder)\n\n    # Initialize counts in the dictionary\n    image_counts[f\"{class_name}_VALID\"] = len(os.listdir(subfolder))\n\n    # Move images from valid to train subfolder and update counts\n    for file in os.listdir(subfolder):\n        file_path = os.path.join(subfolder, file)\n        dest_path = os.path.join(train_subfolder, file)\n        shutil.move(file_path, dest_path)\n\n\n# Remove the empty valid subfolders\nfor subfolder in valid_subfolders:\n    os.rmdir(subfolder)\n\n# Get count of images in train folder so that we can understand on how much we are training\nfor subfolder in train_subfolders:\n    class_name = os.path.basename(subfolder)\n    image_counts[f\"{class_name}_TRAIN\"] = len(os.listdir(subfolder))\n\nsorted_image_counts = dict(sorted(image_counts.items()))\n\n# Print the sorted image counts dictionary\nprint(\"Sorted Image Counts:\")\nfor key, value in sorted_image_counts.items():\n    print(f\"{key}: {value}\")\n\n```\n\n    Sorted Image Counts:\n    AFRICAN LEOPARD_TRAIN: 241\n    AFRICAN LEOPARD_VALID: 5\n    CARACAL_TRAIN: 241\n    CARACAL_VALID: 5\n    CHEETAH_TRAIN: 240\n    CHEETAH_VALID: 5\n    CLOUDED LEOPARD_TRAIN: 234\n    CLOUDED LEOPARD_VALID: 5\n    JAGUAR_TRAIN: 243\n    JAGUAR_VALID: 5\n    LIONS_TRAIN: 233\n    LIONS_VALID: 5\n    OCELOT_TRAIN: 238\n    OCELOT_VALID: 5\n    PUMA_TRAIN: 241\n    PUMA_VALID: 5\n    SNOW LEOPARD_TRAIN: 236\n    SNOW LEOPARD_VALID: 5\n    TIGER_TRAIN: 242\n    TIGER_VALID: 5\n    \n\n#### Install latest FastAI Version\n\n\n```python\n#hide\n! [ -e /content ] && pip install -Uqq fastbook\n! pip install timm\n\nimport fastbook\nfastbook.setup_book()\nimport timm\n\n#hide\nfrom fastbook import *\nfrom fastai.vision.widgets import *\nfrom fastai.vision.all import *\n\n```\n\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m719.8/719.8 kB[0m [31m7.1 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m510.5/510.5 kB[0m [31m11.6 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m116.3/116.3 kB[0m [31m13.7 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m194.1/194.1 kB[0m [31m2.0 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m134.8/134.8 kB[0m [31m12.0 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m1.6/1.6 MB[0m [31m19.3 MB/s[0m eta [36m0:00:00[0m\n    [?25hCollecting timm\n      Downloading timm-0.9.16-py3-none-any.whl (2.2 MB)\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m2.2/2.2 MB[0m [31m15.2 MB/s[0m eta [36m0:00:00[0m\n    [?25hRequirement already satisfied: torch in /usr/local/lib/python3.10/dist-packages (from timm) (2.2.1+cu121)\n    Requirement already satisfied: torchvision in /usr/local/lib/python3.10/dist-packages (from timm) (0.17.1+cu121)\n    Requirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from timm) (6.0.1)\n    Requirement already satisfied: huggingface_hub in /usr/local/lib/python3.10/dist-packages (from timm) (0.20.3)\n    Requirement already satisfied: safetensors in /usr/local/lib/python3.10/dist-packages (from timm) (0.4.2)\n    Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (3.13.3)\n    Requirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2023.6.0)\n    Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2.31.0)\n    Requirement already satisfied: tqdm>=4.42.1 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.66.2)\n    Requirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.10.0)\n    Requirement already satisfied: packaging>=20.9 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (24.0)\n    Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch->timm) (1.12)\n    Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.2.1)\n    Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.1.3)\n    Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: nvidia-cudnn-cu12==8.9.2.26 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (8.9.2.26)\n    Requirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.3.1)\n    Requirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.0.2.54)\n    Requirement already satisfied: nvidia-curand-cu12==10.3.2.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (10.3.2.106)\n    Requirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.4.5.107)\n    Requirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.0.106)\n    Requirement already satisfied: nvidia-nccl-cu12==2.19.3 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.19.3)\n    Requirement already satisfied: nvidia-nvtx-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: triton==2.2.0 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.2.0)\n    Requirement already satisfied: nvidia-nvjitlink-cu12 in /usr/local/lib/python3.10/dist-packages (from nvidia-cusolver-cu12==11.4.5.107->torch->timm) (12.4.127)\n    Requirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (1.25.2)\n    Requirement already satisfied: pillow!=8.3.*,>=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (9.4.0)\n    Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->torch->timm) (2.1.5)\n    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.3.2)\n    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.6)\n    Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2.0.7)\n    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2024.2.2)\n    Requirement already satisfied: mpmath>=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy->torch->timm) (1.3.0)\n    Installing collected packages: timm\n    Successfully installed timm-0.9.16\n    Mounted at /content/gdrive\n    \n\n` verify_images()` will return path of images which are corrupt and using `unlink` we can remove these files.\n\n\n```python\npath = Path('Big_Cat')\n\nfns = get_image_files(path)\ntotal_imagelength = len(fns)\nfailed = verify_images(fns)\nfailed_imagelength = len(failed)\n\nfailed.map(Path.unlink)\nImage_Count_Dict = {\"Total_Image_Count\": total_imagelength, \"Failed_Image_Count\": failed_imagelength}\nImage_Count_Dict\n```\n\n    /usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n      self.pid = os.fork()\n    \n\n\n\n\n    {'Total_Image_Count': 2439, 'Failed_Image_Count': 0}\n\n\n\nWe have good chunk of images to be trained on\n\n### 1.2 : Prepare data for model training (Data Loaders, Data Augmentaion, etc.).\n\n#### Data Loaders\n\n\n```python\nbig_cat = DataBlock(\n    blocks=(ImageBlock, CategoryBlock),\n    get_items=get_image_files,\n    splitter=RandomSplitter(valid_pct=0.2, seed=42),\n    get_y=parent_label,\n    item_tfms=Resize(128))\ndls = big_cat.dataloaders(path)\n\ndls.valid.show_batch(max_n=8, nrows=2)\n```\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_15_0.png)\n    \n\n\n#### Data Augmentation\n\n\n```python\nbig_cat = big_cat.new(\n    item_tfms=RandomResizedCrop(224, min_scale=0.5),\n    batch_tfms=aug_transforms())\nbig_cat_dls = big_cat.dataloaders(path)\nbig_cat_dls.train.show_batch(max_n=8, nrows=2)\n```\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_17_0.png)\n    \n\n\n### 1.3 : Train Model\n\n\n```python\nlearn = vision_learner(big_cat_dls, resnet34, metrics=error_rate)\nlearn.fine_tune(5)\n```\n\n    Downloading: \"https://download.pytorch.org/models/resnet34-b627a593.pth\" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth\n    100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 83.3M/83.3M [00:00<00:00, 164MB/s]\n    \n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>1.837715</td>\n      <td>0.237122</td>\n      <td>0.088296</td>\n      <td>00:13</td>\n    </tr>\n  </tbody>\n</table>\n\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>0.565063</td>\n      <td>0.141556</td>\n      <td>0.041068</td>\n      <td>00:18</td>\n    </tr>\n    <tr>\n      <td>1</td>\n      <td>0.431256</td>\n      <td>0.147855</td>\n      <td>0.051335</td>\n      <td>00:20</td>\n    </tr>\n    <tr>\n      <td>2</td>\n      <td>0.337753</td>\n      <td>0.119496</td>\n      <td>0.036961</td>\n      <td>00:17</td>\n    </tr>\n    <tr>\n      <td>3</td>\n      <td>0.268090</td>\n      <td>0.115800</td>\n      <td>0.032854</td>\n      <td>00:14</td>\n    </tr>\n  </tbody>\n</table>\n\n\nunderstand structure of model\n\n\n```python\nlearn.summary()\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    Sequential (Input shape: 64 x 3 x 224 x 224)\n    ============================================================================\n    Layer (type)         Output Shape         Param #    Trainable \n    ============================================================================\n                         64 x 64 x 112 x 112 \n    Conv2d                                    9408       True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    ____________________________________________________________________________\n                         64 x 64 x 56 x 56   \n    MaxPool2d                                                      \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ____________________________________________________________________________\n                         64 x 128 x 28 x 28  \n    Conv2d                                    73728      True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    8192       True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ____________________________________________________________________________\n                         64 x 256 x 14 x 14  \n    Conv2d                                    294912     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    32768      True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ____________________________________________________________________________\n                         64 x 512 x 7 x 7    \n    Conv2d                                    1179648    True      \n    BatchNorm2d                               1024       True      \n    ReLU                                                           \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    Conv2d                                    131072     True      \n    BatchNorm2d                               1024       True      \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    ReLU                                                           \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    ReLU                                                           \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    ____________________________________________________________________________\n                         64 x 512 x 1 x 1    \n    AdaptiveAvgPool2d                                              \n    AdaptiveMaxPool2d                                              \n    ____________________________________________________________________________\n                         64 x 1024           \n    Flatten                                                        \n    BatchNorm1d                               2048       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 512            \n    Linear                                    524288     True      \n    ReLU                                                           \n    BatchNorm1d                               1024       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 10             \n    Linear                                    5120       True      \n    ____________________________________________________________________________\n    \n    Total params: 21,817,152\n    Total trainable params: 21,817,152\n    Total non-trainable params: 0\n    \n    Optimizer used: <function Adam at 0x7b5a37dbbeb0>\n    Loss function: FlattenedLoss of CrossEntropyLoss()\n    \n    Model unfrozen\n    \n    Callbacks:\n      - TrainEvalCallback\n      - CastToTensor\n      - Recorder\n      - ProgressCallback\n\n\n\n#### Confusion Metric\n\n\n```python\ninterp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_23_4.png)\n    \n\n\n#### Display Images with highest loss, to Get the picture ðŸ˜Š\n\n\n```python\ninterp.plot_top_losses(6, nrows=2, figsize=(18,4))\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_25_2.png)\n    \n\n\nWe can observe from both the confusion matrix and visual representation that the model is having difficulty differentiating between the Jaguar and the African Leopard. Even I find it challenging to distinguish between the two. ðŸ˜µ So, we can let it be.\n\n### 1.4 : Clear the data\n\n\n```python\n#hide_output\ncleaner = ImageClassifierCleaner(learn)\ncleaner\n\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n    VBox(children=(Dropdown(options=('AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS'â€¦\n\n\n#### Apply those changes\n\n\n```python\nfor idx in cleaner.delete(): cleaner.fns[idx].unlink()\nfor idx,cat in cleaner.change(): shutil.move(str(cleaner.fns[idx]), path/cat)\n```\n\n## Level 2 : Understand Computer Vision Architectures\n\n#### [timm](https://timm.fast.ai/)   is a wonderful library by Ross Wightman which provides state-of-the-art pre-trained computer vision models. It's like Huggingface Transformers, but for computer vision instead of NLP.\n\n\n### 2.1 : Download Data\nLet's download Ross's GitHub repository, which is regularly updated with benchmark data for computer vision architectures.\nThese benchmark are created on **Imagenet.**\n\n\n```python\n! git clone --depth 1 https://github.com/rwightman/pytorch-image-models.git\n%cd pytorch-image-models/results\n```\n\n    Cloning into 'pytorch-image-models'...\n    remote: Enumerating objects: 572, done.[K\n    remote: Counting objects: 100% (572/572), done.[K\n    remote: Compressing objects: 100% (403/403), done.[K\n    remote: Total 572 (delta 222), reused 341 (delta 163), pack-reused 0[K\n    Receiving objects: 100% (572/572), 2.59 MiB | 4.87 MiB/s, done.\n    Resolving deltas: 100% (222/222), done.\n    /content/pytorch-image-models/results/pytorch-image-models/results\n    \n\n\n```python\nimport pandas as pd\n\nBenchmark_Result = pd.read_csv('results-imagenet.csv')\nBenchmark_Result['model_org'] = Benchmark_Result['model']\nBenchmark_Result['model'] = Benchmark_Result['model'].str.split('.').str[0]\nBenchmark_Result.head(5)\n```\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>model</th>\n      <th>top1</th>\n      <th>top1_err</th>\n      <th>top5</th>\n      <th>top5_err</th>\n      <th>param_count</th>\n      <th>img_size</th>\n      <th>crop_pct</th>\n      <th>interpolation</th>\n      <th>model_org</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>eva02_large_patch14_448</td>\n      <td>90.052</td>\n      <td>9.948</td>\n      <td>99.048</td>\n      <td>0.952</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_m38m_ft_in22k_in1k</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>eva02_large_patch14_448</td>\n      <td>89.970</td>\n      <td>10.030</td>\n      <td>99.012</td>\n      <td>0.988</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_in22k_ft_in22k_in1k</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>eva_giant_patch14_560</td>\n      <td>89.786</td>\n      <td>10.214</td>\n      <td>98.992</td>\n      <td>1.008</td>\n      <td>1,014.45</td>\n      <td>560</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva_giant_patch14_560.m30m_ft_in22k_in1k</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>eva02_large_patch14_448</td>\n      <td>89.622</td>\n      <td>10.378</td>\n      <td>98.950</td>\n      <td>1.050</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_in22k_ft_in1k</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>eva02_large_patch14_448</td>\n      <td>89.574</td>\n      <td>10.426</td>\n      <td>98.924</td>\n      <td>1.076</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_m38m_ft_in1k</td>\n    </tr>\n  </tbody>\n</table>\n\n\nLet's add a \"family\" column that will allow us to group architectures into categories with similar characteristics:\n\n\n```python\ndef get_data(part, col):\n    df = pd.read_csv(f'benchmark-{part}-amp-nhwc-pt111-cu113-rtx3090.csv').merge(Benchmark_Result, on='model')\n    df['secs'] = 1. / df[col]\n    df['family'] = df.model.str.extract('^([a-z]+?(?:v2)?)(?:\\d|_|$)')\n    df = df[~df.model.str.endswith('gn')]\n    df.loc[df.model.str.contains('in22'),'family'] = df.loc[df.model.str.contains('in22'),'family'] + '_in22'\n    df.loc[df.model.str.contains('resnet.*d'),'family'] = df.loc[df.model.str.contains('resnet.*d'),'family'] + 'd'\n    return df[df.family.str.contains('^re[sg]netd?|beit|convnext|levit|efficient|vit|vgg|swin')]\n\nInference_Data = get_data('infer', 'infer_samples_per_sec')\nInference_Data.head(5)\n```\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>model</th>\n      <th>infer_samples_per_sec</th>\n      <th>infer_step_time</th>\n      <th>infer_batch_size</th>\n      <th>infer_img_size</th>\n      <th>param_count_x</th>\n      <th>top1</th>\n      <th>top1_err</th>\n      <th>top5</th>\n      <th>top5_err</th>\n      <th>param_count_y</th>\n      <th>img_size</th>\n      <th>crop_pct</th>\n      <th>interpolation</th>\n      <th>model_org</th>\n      <th>secs</th>\n      <th>family</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>12</th>\n      <td>levit_128s</td>\n      <td>21485.80</td>\n      <td>47.648</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>7.78</td>\n      <td>76.526</td>\n      <td>23.474</td>\n      <td>92.872</td>\n      <td>7.128</td>\n      <td>7.78</td>\n      <td>224</td>\n      <td>0.900</td>\n      <td>bicubic</td>\n      <td>levit_128s.fb_dist_in1k</td>\n      <td>0.000047</td>\n      <td>levit</td>\n    </tr>\n    <tr>\n      <th>13</th>\n      <td>regnetx_002</td>\n      <td>17821.98</td>\n      <td>57.446</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>2.68</td>\n      <td>68.752</td>\n      <td>31.248</td>\n      <td>88.542</td>\n      <td>11.458</td>\n      <td>2.68</td>\n      <td>224</td>\n      <td>0.875</td>\n      <td>bicubic</td>\n      <td>regnetx_002.pycls_in1k</td>\n      <td>0.000056</td>\n      <td>regnetx</td>\n    </tr>\n    <tr>\n      <th>15</th>\n      <td>regnety_002</td>\n      <td>16673.08</td>\n      <td>61.405</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>3.16</td>\n      <td>70.280</td>\n      <td>29.720</td>\n      <td>89.530</td>\n      <td>10.470</td>\n      <td>3.16</td>\n      <td>224</td>\n      <td>0.875</td>\n      <td>bicubic</td>\n      <td>regnety_002.pycls_in1k</td>\n      <td>0.000060</td>\n      <td>regnety</td>\n    </tr>\n    <tr>\n      <th>17</th>\n      <td>levit_128</td>\n      <td>14657.83</td>\n      <td>69.849</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>9.21</td>\n      <td>78.490</td>\n      <td>21.510</td>\n      <td>94.012</td>\n      <td>5.988</td>\n      <td>9.21</td>\n      <td>224</td>\n      <td>0.900</td>\n      <td>bicubic</td>\n      <td>levit_128.fb_dist_in1k</td>\n      <td>0.000068</td>\n      <td>levit</td>\n    </tr>\n    <tr>\n      <th>18</th>\n      <td>regnetx_004</td>\n      <td>14440.03</td>\n      <td>70.903</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>5.16</td>\n      <td>72.402</td>\n      <td>27.598</td>\n      <td>90.826</td>\n      <td>9.174</td>\n      <td>5.16</td>\n      <td>224</td>\n      <td>0.875</td>\n      <td>bicubic</td>\n      <td>regnetx_004.pycls_in1k</td>\n      <td>0.000069</td>\n      <td>regnetx</td>\n    </tr>\n  </tbody>\n</table>\n\n### 2.2 : Plot of all the architectures.\n\nHere's the results for inference performance (see the last section for training performance). In this chart:\n\n\n*   the x axis shows how many seconds it takes to process one image (note: it's a log scale)\n*  the y axis is the accuracy on Imagenet\n\n*   the size of each bubble is proportional to the size of images used in testing\n*  the color shows what \"family\" the architecture is from.\n\n\nHover your mouse over a marker to see details about the model. Double-click in the legend to display just one family. Single-click in the legend to show or hide a family.\n\n\n\n\n\n\n\n\n\n```python\nimport plotly.express as px\nw,h = 1000,800\n\ndef show_all(Inference_Data, title, size):\n    return px.scatter(Inference_Data, width=w, height=h, size=Inference_Data[size]**2, title=title,\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n\n\n```\n\n\n```python\nshow_all(Inference_Data, 'Inference', 'infer_img_size')\n```\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_2.PNG)\n\n\n### 2.3 : Specific Architectures Plot\nLet's create a plot for selected architectures which we would like to use normally\n\n\n```python\n# Filter data only for convnext, resnet\nkeywords = ['convnext', 'resnet','levit','beit']\n\n# Filter rows based on the exact keywords\nBest_Model_Df = Inference_Data[Inference_Data['family'].isin(keywords)]\n\nshow_all(Best_Model_Df, 'Inference', 'infer_img_size')\n```\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_3.PNG)\n\n\n### 2.4 : Family Connection Plot\n Let's add lines through the points of each family, to help see how they compare -- but note that we can see that a linear fit isn't actually ideal here! It's just there to help visually see the groups.\n\n\n```python\nsubs = 'levit|resnetd?|regnetx|vgg|convnext.*|efficientnetv2|beit|swin'\n\ndef show_subs(Inference_Data, title, size):\n    df_subs = Inference_Data[Inference_Data.family.str.fullmatch(subs)]\n    return px.scatter(df_subs, width=w, height=h, size=df_subs[size]**2, title=title,\n        trendline=\"ols\", trendline_options={'log_x':True},\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n```\n\n\n```python\nshow_subs(Inference_Data, 'Inference', 'infer_img_size')\n```\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_4.PNG)\n\n\n#### We can conclude that `Convnext` can be go to model with decent GPU at our disposal, because it has more accuracy then resenet and it take less time than `beit`\n\n## Level 3 : Build a model using Convnext(basic or tiny)\n\nList of all the basic & tiny version models in `Convnext` and choose the best.\n\n\n```python\n[model for model in timm.list_models('convnext*') if 'base' in model or 'tiny' in model]\n```\n\n\n\n\n    ['convnext_base',\n     'convnext_tiny',\n     'convnext_tiny_hnf',\n     'convnextv2_base',\n     'convnextv2_tiny']\n\n\n\n\n```python\nlearn_conv = vision_learner(dls, convnext_base, metrics=error_rate).to_fp16()\nlearn_conv.fine_tune(5)\n```\n\n    /usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.\n      warnings.warn(\n    /usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ConvNeXt_Base_Weights.IMAGENET1K_V1`. You can also use `weights=ConvNeXt_Base_Weights.DEFAULT` to get the most up-to-date weights.\n      warnings.warn(msg)\n    \n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>1.130588</td>\n      <td>0.183650</td>\n      <td>0.045175</td>\n      <td>00:17</td>\n    </tr>\n  </tbody>\n</table>\n\n\n    /usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n      self.pid = os.fork()\n    /usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n      self.pid = os.fork()\n    \n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>0.306945</td>\n      <td>0.164550</td>\n      <td>0.047228</td>\n      <td>00:20</td>\n    </tr>\n    <tr>\n      <td>1</td>\n      <td>0.253462</td>\n      <td>0.118687</td>\n      <td>0.026694</td>\n      <td>00:11</td>\n    </tr>\n    <tr>\n      <td>2</td>\n      <td>0.207020</td>\n      <td>0.103058</td>\n      <td>0.024641</td>\n      <td>00:11</td>\n    </tr>\n    <tr>\n      <td>3</td>\n      <td>0.175618</td>\n      <td>0.094374</td>\n      <td>0.020534</td>\n      <td>00:11</td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>0.151438</td>\n      <td>0.092010</td>\n      <td>0.020534</td>\n      <td>00:13</td>\n    </tr>\n  </tbody>\n</table>\n\nCompared to the `resnet34` model, which had an error rate of 32%, the `convnext_base` model demonstrates a significant improvement with an error rate of just 21%\n\nStructure of the architecture\n\n\n```python\nlearn_conv.summary()\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    Sequential (Input shape: 64 x 3 x 128 x 128)\n    ============================================================================\n    Layer (type)         Output Shape         Param #    Trainable \n    ============================================================================\n                         64 x 128 x 32 x 32  \n    Conv2d                                    6272       True      \n    LayerNorm2d                               256        True      \n    Conv2d                                    6400       True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Permute                                                        \n    LayerNorm                                 256        True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 512  \n    Linear                                    66048      True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Linear                                    65664      True      \n    ____________________________________________________________________________\n                         64 x 128 x 32 x 32  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    6400       True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Permute                                                        \n    LayerNorm                                 256        True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 512  \n    Linear                                    66048      True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Linear                                    65664      True      \n    ____________________________________________________________________________\n                         64 x 128 x 32 x 32  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    6400       True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Permute                                                        \n    LayerNorm                                 256        True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 512  \n    Linear                                    66048      True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Linear                                    65664      True      \n    ____________________________________________________________________________\n                         64 x 128 x 32 x 32  \n    Permute                                                        \n    StochasticDepth                                                \n    LayerNorm2d                               256        True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Conv2d                                    131328     True      \n    Conv2d                                    12800      True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Permute                                                        \n    LayerNorm                                 512        True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 1024 \n    Linear                                    263168     True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Linear                                    262400     True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    12800      True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Permute                                                        \n    LayerNorm                                 512        True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 1024 \n    Linear                                    263168     True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Linear                                    262400     True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    12800      True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Permute                                                        \n    LayerNorm                                 512        True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 1024 \n    Linear                                    263168     True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Linear                                    262400     True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Permute                                                        \n    StochasticDepth                                                \n    LayerNorm2d                               512        True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Conv2d                                    524800     True      \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    LayerNorm2d                               1024       True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Conv2d                                    2098176    True      \n    Conv2d                                    51200      True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Permute                                                        \n    LayerNorm                                 2048       True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 4096   \n    Linear                                    4198400    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Linear                                    4195328    True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    51200      True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Permute                                                        \n    LayerNorm                                 2048       True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 4096   \n    Linear                                    4198400    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Linear                                    4195328    True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    51200      True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Permute                                                        \n    LayerNorm                                 2048       True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 4096   \n    Linear                                    4198400    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Linear                                    4195328    True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Permute                                                        \n    StochasticDepth                                                \n    ____________________________________________________________________________\n                         64 x 1024 x 1 x 1   \n    AdaptiveAvgPool2d                                              \n    AdaptiveMaxPool2d                                              \n    ____________________________________________________________________________\n                         64 x 2048           \n    Flatten                                                        \n    BatchNorm1d                               4096       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 512            \n    Linear                                    1048576    True      \n    ReLU                                                           \n    BatchNorm1d                               1024       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 10             \n    Linear                                    5120       True      \n    ____________________________________________________________________________\n    \n    Total params: 88,605,184\n    Total trainable params: 88,605,184\n    Total non-trainable params: 0\n    \n    Optimizer used: <function Adam at 0x7b5a37dbbeb0>\n    Loss function: FlattenedLoss of CrossEntropyLoss()\n    \n    Model unfrozen\n    \n    Callbacks:\n      - TrainEvalCallback\n      - CastToTensor\n      - MixedPrecision\n      - Recorder\n      - ProgressCallback\n\n\n\nLet's downlod the model for future reference\n\n\n```python\nlearn_conv.export('Big_Cat_Convnext_Model.pkl')\n#learn_conv.export('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n## Level 4. Test the Model\n\n\nLet's test the model with an image\n\n\n```python\nfrom fastai.vision.all import *\nimport gradio as gr\n```\n\n\n```python\nim = PILImage.create('/content/drive/MyDrive/Colab Notebooks/FastAI Course/SnowLeopard.jpg')\nim.thumbnail((224,224))\nim\n```\n\n\n\n\n    \n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_59_0.png)\n    \n\n\n\n\n```python\nlearn_conv = load_learner('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n\n```python\nlearn_conv.predict(im)\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    ('CHEETAH',\n     tensor(2),\n     tensor([1.0988e-04, 8.7617e-05, 9.2564e-01, 2.9294e-06, 1.2592e-06, 1.6162e-06,\n             2.6748e-02, 6.5111e-07, 4.7398e-02, 7.3348e-06]))\n\n\n\n\n```python\nlearn_conv.dls.vocab\n```\n\n\n\n\n    ['AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS', 'OCELOT', 'PUMA', 'SNOW LEOPARD', 'TIGER']\n\n\n\n\n```python\ncategories = learn_conv.dls.vocab\n\npred, idx, probs = learn_conv.predict(im)\nresult = dict(zip(categories, map(float,probs)))\nresult\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    {'AFRICAN LEOPARD': 0.00010988322173943743,\n     'CARACAL': 8.761714707361534e-05,\n     'CHEETAH': 0.9256432056427002,\n     'CLOUDED LEOPARD': 2.929433776444057e-06,\n     'JAGUAR': 1.2592141729328432e-06,\n     'LIONS': 1.6162448446266353e-06,\n     'OCELOT': 0.026747871190309525,\n     'PUMA': 6.511066317216319e-07,\n     'SNOW LEOPARD': 0.04739758372306824,\n     'TIGER': 7.334848760365276e-06}\n\n\n\nTop 3 Predicted Cat Names with Highest Probability\"\n\n\n```python\nsorted_result = dict(sorted(result.items(), key=lambda item: item[1], reverse=True))\ntop_classes = list(sorted_result.keys())[:3]\ntop_classes\n```\n\n\n\n\n    ['CHEETAH', 'SNOW LEOPARD', 'OCELOT']\n\n\n\nSo our model predicted `CHEETAH` with probablity of 93%","srcMarkdownNoYaml":"\n# This code aims to upscale our last lession.\nPreviously, we obtained our data from the DuckDuckGo API and built our model around that.\n\nThis time, we will retrieve data from a Kaggle dataset, enhance our model, improve our understanding of different available pre-trained vision architectures in PyTorch using the `timm` library, and implement another model according to our requirements.\n\n## Level 1 : Repeat last lesson\n\n### 1.1 : Download dataset from Kaggle\n\n\n```python\nfrom google.colab import files\n\n# Upload the Kaggle API key JSON file\nuploaded = files.upload()\n\n!pip install kaggle\n\n!mkdir -p ~/.kaggle\n!mv kaggle.json ~/.kaggle/\n!chmod 600 ~/.kaggle/kaggle.json\n```\n\n    Saving kaggle.json to kaggle.json\n    Requirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)\n    Requirement already satisfied: six>=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)\n    Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2024.2.2)\n    Requirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)\n    Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)\n    Requirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.2)\n    Requirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.4)\n    Requirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)\n    Requirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)\n    Requirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach->kaggle) (0.5.1)\n    Requirement already satisfied: text-unidecode>=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify->kaggle) (1.3)\n    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.3.2)\n    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.6)\n    \n\n#### Download dataset :\nOpen dataset in Kaggle, click on 3 vertical dots (ellipsis) then click on Copy API comamnd, and we are good to go.\n\n\n```python\n!kaggle datasets download -d gpiosenka/cats-in-the-wild-image-classification\n\n# Create a folder called \"Big Cat\"\n!mkdir -p Big_Cat\n\n# Unzip the dataset into the \"Big Cat\" folder\n!unzip cats-in-the-wild-image-classification.zip -d Big_Cat\n\n# Remove the zip file\n!rm cats-in-the-wild-image-classification.zip\n```\n\n    Downloading cats-in-the-wild-image-classification.zip to /content\n     96% 118M/123M [00:01<00:00, 57.4MB/s]\n    100% 123M/123M [00:01<00:00, 65.0MB/s]\n    Archive:  cats-in-the-wild-image-classification.zip\n      inflating: Big_Cat/EfficientNetB0-10-(224 X 224)-100.00.h5  \n      inflating: Big_Cat/MobileNetV3 small-10-(224 X 224)-95.96.h5  \n      inflating: Big_Cat/WILDCATS.CSV    \n      inflating: Big_Cat/test/AFRICAN LEOPARD/1.jpg  \n      inflating: Big_Cat/test/AFRICAN LEOPARD/5.jpg  \n      inflating: Big_Cat/test/CARACAL/1.jpg  \n      inflating: Big_Cat/test/CARACAL/5.jpg  \n      inflating: Big_Cat/test/CHEETAH/1.jpg  \n      inflating: Big_Cat/test/CHEETAH/5.jpg  \n      inflating: Big_Cat/test/CLOUDED LEOPARD/1.jpg  \n      inflating: Big_Cat/test/CLOUDED LEOPARD/5.jpg  \n      inflating: Big_Cat/test/JAGUAR/1.jpg  \n      inflating: Big_Cat/test/JAGUAR/5.jpg  \n      inflating: Big_Cat/test/LIONS/1.jpg  \n      inflating: Big_Cat/test/LIONS/5.jpg  \n      inflating: Big_Cat/test/OCELOT/1.jpg  \n      inflating: Big_Cat/test/OCELOT/5.jpg  \n      inflating: Big_Cat/test/PUMA/1.jpg  \n      inflating: Big_Cat/test/PUMA/5.jpg  \n      inflating: Big_Cat/test/SNOW LEOPARD/1.jpg  \n      inflating: Big_Cat/test/SNOW LEOPARD/5.jpg  \n      inflating: Big_Cat/test/TIGER/1.jpg  \n      inflating: Big_Cat/test/TIGER/5.jpg  \n      inflating: Big_Cat/train/AFRICAN LEOPARD/001.jpg  \n      inflating: Big_Cat/train/AFRICAN LEOPARD/236.jpg  \n      inflating: Big_Cat/train/CARACAL/001.jpg  \n      inflating: Big_Cat/train/CARACAL/236.jpg  \n      inflating: Big_Cat/train/CHEETAH/001.jpg  \n      inflating: Big_Cat/train/CHEETAH/235.jpg  \n      inflating: Big_Cat/train/CLOUDED LEOPARD/001.jpg  \n      inflating: Big_Cat/train/CLOUDED LEOPARD/229.jpg  \n      inflating: Big_Cat/train/JAGUAR/001.jpg  \n      inflating: Big_Cat/train/JAGUAR/238.jpg  \n      inflating: Big_Cat/train/LIONS/001.jpg  \n      inflating: Big_Cat/train/LIONS/228.jpg  \n      inflating: Big_Cat/train/OCELOT/001.jpg  \n      inflating: Big_Cat/train/OCELOT/233.jpg  \n      inflating: Big_Cat/train/PUMA/001.jpg  \n      inflating: Big_Cat/train/PUMA/236.jpg  \n      inflating: Big_Cat/train/SNOW LEOPARD/001.jpg  \n      inflating: Big_Cat/train/SNOW LEOPARD/231.jpg  \n      inflating: Big_Cat/train/TIGER/001.jpg  \n      inflating: Big_Cat/train/TIGER/237.jpg  \n      inflating: Big_Cat/valid/AFRICAN LEOPARD/1.jpg  \n      inflating: Big_Cat/valid/AFRICAN LEOPARD/5.jpg  \n      inflating: Big_Cat/valid/CARACAL/1.jpg\n      inflating: Big_Cat/valid/CARACAL/5.jpg  \n      inflating: Big_Cat/valid/CHEETAH/1.jpg  \n      inflating: Big_Cat/valid/CHEETAH/5.jpg  \n      inflating: Big_Cat/valid/CLOUDED LEOPARD/1.jpg  \n      inflating: Big_Cat/valid/CLOUDED LEOPARD/5.jpg  \n      inflating: Big_Cat/valid/JAGUAR/1.jpg  \n      inflating: Big_Cat/valid/JAGUAR/5.jpg  \n      inflating: Big_Cat/valid/LIONS/1.jpg  \n      inflating: Big_Cat/valid/LIONS/5.jpg  \n      inflating: Big_Cat/valid/OCELOT/1.jpg  \n      inflating: Big_Cat/valid/OCELOT/5.jpg  \n      inflating: Big_Cat/valid/PUMA/1.jpg  \n      inflating: Big_Cat/valid/PUMA/5.jpg  \n      inflating: Big_Cat/valid/SNOW LEOPARD/1.jpg  \n      inflating: Big_Cat/valid/SNOW LEOPARD/5.jpg  \n      inflating: Big_Cat/valid/TIGER/1.jpg  \n      inflating: Big_Cat/valid/TIGER/5.jpg  \n    \n\n#### Remove all files with the \".h5\" extension and move images from the \"valid\" folder to their corresponding subfolders in the \"train\" folder\n\n\n```python\nimport os\nimport shutil\n\n# Define the absolute paths of main, train and valid folders\nbig_cat_folder = '/content/Big_Cat/'\ntrain_folder = '/content/Big_Cat/train'\nvalid_folder = '/content/Big_Cat/valid'\n\n# Remove all files with \".h5\" extension\n!find {big_cat_folder} -type f -name '*.h5' -delete\n\n# Create a dictionary to track image counts\nimage_counts = {}\n\n# Get a list of subfolders in the train folder\ntrain_subfolders = [f.path for f in os.scandir(train_folder) if f.is_dir()]\n\n# Get a list of subfolders in the valid folder\nvalid_subfolders = [f.path for f in os.scandir(valid_folder) if f.is_dir()]\n\n# Move images from valid to their corresponding subfolders in train\nfor subfolder in valid_subfolders:\n    class_name = os.path.basename(subfolder)\n    train_subfolder = os.path.join(train_folder, class_name)\n\n    # Create the train subfolder if it doesn't exist\n    if not os.path.exists(train_subfolder):\n        os.makedirs(train_subfolder)\n\n    # Initialize counts in the dictionary\n    image_counts[f\"{class_name}_VALID\"] = len(os.listdir(subfolder))\n\n    # Move images from valid to train subfolder and update counts\n    for file in os.listdir(subfolder):\n        file_path = os.path.join(subfolder, file)\n        dest_path = os.path.join(train_subfolder, file)\n        shutil.move(file_path, dest_path)\n\n\n# Remove the empty valid subfolders\nfor subfolder in valid_subfolders:\n    os.rmdir(subfolder)\n\n# Get count of images in train folder so that we can understand on how much we are training\nfor subfolder in train_subfolders:\n    class_name = os.path.basename(subfolder)\n    image_counts[f\"{class_name}_TRAIN\"] = len(os.listdir(subfolder))\n\nsorted_image_counts = dict(sorted(image_counts.items()))\n\n# Print the sorted image counts dictionary\nprint(\"Sorted Image Counts:\")\nfor key, value in sorted_image_counts.items():\n    print(f\"{key}: {value}\")\n\n```\n\n    Sorted Image Counts:\n    AFRICAN LEOPARD_TRAIN: 241\n    AFRICAN LEOPARD_VALID: 5\n    CARACAL_TRAIN: 241\n    CARACAL_VALID: 5\n    CHEETAH_TRAIN: 240\n    CHEETAH_VALID: 5\n    CLOUDED LEOPARD_TRAIN: 234\n    CLOUDED LEOPARD_VALID: 5\n    JAGUAR_TRAIN: 243\n    JAGUAR_VALID: 5\n    LIONS_TRAIN: 233\n    LIONS_VALID: 5\n    OCELOT_TRAIN: 238\n    OCELOT_VALID: 5\n    PUMA_TRAIN: 241\n    PUMA_VALID: 5\n    SNOW LEOPARD_TRAIN: 236\n    SNOW LEOPARD_VALID: 5\n    TIGER_TRAIN: 242\n    TIGER_VALID: 5\n    \n\n#### Install latest FastAI Version\n\n\n```python\n#hide\n! [ -e /content ] && pip install -Uqq fastbook\n! pip install timm\n\nimport fastbook\nfastbook.setup_book()\nimport timm\n\n#hide\nfrom fastbook import *\nfrom fastai.vision.widgets import *\nfrom fastai.vision.all import *\n\n```\n\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m719.8/719.8 kB[0m [31m7.1 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m510.5/510.5 kB[0m [31m11.6 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m116.3/116.3 kB[0m [31m13.7 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m194.1/194.1 kB[0m [31m2.0 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m134.8/134.8 kB[0m [31m12.0 MB/s[0m eta [36m0:00:00[0m\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m1.6/1.6 MB[0m [31m19.3 MB/s[0m eta [36m0:00:00[0m\n    [?25hCollecting timm\n      Downloading timm-0.9.16-py3-none-any.whl (2.2 MB)\n    [2K     [90mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m [32m2.2/2.2 MB[0m [31m15.2 MB/s[0m eta [36m0:00:00[0m\n    [?25hRequirement already satisfied: torch in /usr/local/lib/python3.10/dist-packages (from timm) (2.2.1+cu121)\n    Requirement already satisfied: torchvision in /usr/local/lib/python3.10/dist-packages (from timm) (0.17.1+cu121)\n    Requirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from timm) (6.0.1)\n    Requirement already satisfied: huggingface_hub in /usr/local/lib/python3.10/dist-packages (from timm) (0.20.3)\n    Requirement already satisfied: safetensors in /usr/local/lib/python3.10/dist-packages (from timm) (0.4.2)\n    Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (3.13.3)\n    Requirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2023.6.0)\n    Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2.31.0)\n    Requirement already satisfied: tqdm>=4.42.1 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.66.2)\n    Requirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.10.0)\n    Requirement already satisfied: packaging>=20.9 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (24.0)\n    Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch->timm) (1.12)\n    Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.2.1)\n    Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.1.3)\n    Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: nvidia-cudnn-cu12==8.9.2.26 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (8.9.2.26)\n    Requirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.3.1)\n    Requirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.0.2.54)\n    Requirement already satisfied: nvidia-curand-cu12==10.3.2.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (10.3.2.106)\n    Requirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.4.5.107)\n    Requirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.0.106)\n    Requirement already satisfied: nvidia-nccl-cu12==2.19.3 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.19.3)\n    Requirement already satisfied: nvidia-nvtx-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\n    Requirement already satisfied: triton==2.2.0 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.2.0)\n    Requirement already satisfied: nvidia-nvjitlink-cu12 in /usr/local/lib/python3.10/dist-packages (from nvidia-cusolver-cu12==11.4.5.107->torch->timm) (12.4.127)\n    Requirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (1.25.2)\n    Requirement already satisfied: pillow!=8.3.*,>=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (9.4.0)\n    Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->torch->timm) (2.1.5)\n    Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.3.2)\n    Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.6)\n    Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2.0.7)\n    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2024.2.2)\n    Requirement already satisfied: mpmath>=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy->torch->timm) (1.3.0)\n    Installing collected packages: timm\n    Successfully installed timm-0.9.16\n    Mounted at /content/gdrive\n    \n\n` verify_images()` will return path of images which are corrupt and using `unlink` we can remove these files.\n\n\n```python\npath = Path('Big_Cat')\n\nfns = get_image_files(path)\ntotal_imagelength = len(fns)\nfailed = verify_images(fns)\nfailed_imagelength = len(failed)\n\nfailed.map(Path.unlink)\nImage_Count_Dict = {\"Total_Image_Count\": total_imagelength, \"Failed_Image_Count\": failed_imagelength}\nImage_Count_Dict\n```\n\n    /usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n      self.pid = os.fork()\n    \n\n\n\n\n    {'Total_Image_Count': 2439, 'Failed_Image_Count': 0}\n\n\n\nWe have good chunk of images to be trained on\n\n### 1.2 : Prepare data for model training (Data Loaders, Data Augmentaion, etc.).\n\n#### Data Loaders\n\n\n```python\nbig_cat = DataBlock(\n    blocks=(ImageBlock, CategoryBlock),\n    get_items=get_image_files,\n    splitter=RandomSplitter(valid_pct=0.2, seed=42),\n    get_y=parent_label,\n    item_tfms=Resize(128))\ndls = big_cat.dataloaders(path)\n\ndls.valid.show_batch(max_n=8, nrows=2)\n```\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_15_0.png)\n    \n\n\n#### Data Augmentation\n\n\n```python\nbig_cat = big_cat.new(\n    item_tfms=RandomResizedCrop(224, min_scale=0.5),\n    batch_tfms=aug_transforms())\nbig_cat_dls = big_cat.dataloaders(path)\nbig_cat_dls.train.show_batch(max_n=8, nrows=2)\n```\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_17_0.png)\n    \n\n\n### 1.3 : Train Model\n\n\n```python\nlearn = vision_learner(big_cat_dls, resnet34, metrics=error_rate)\nlearn.fine_tune(5)\n```\n\n    Downloading: \"https://download.pytorch.org/models/resnet34-b627a593.pth\" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth\n    100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 83.3M/83.3M [00:00<00:00, 164MB/s]\n    \n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>1.837715</td>\n      <td>0.237122</td>\n      <td>0.088296</td>\n      <td>00:13</td>\n    </tr>\n  </tbody>\n</table>\n\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>0.565063</td>\n      <td>0.141556</td>\n      <td>0.041068</td>\n      <td>00:18</td>\n    </tr>\n    <tr>\n      <td>1</td>\n      <td>0.431256</td>\n      <td>0.147855</td>\n      <td>0.051335</td>\n      <td>00:20</td>\n    </tr>\n    <tr>\n      <td>2</td>\n      <td>0.337753</td>\n      <td>0.119496</td>\n      <td>0.036961</td>\n      <td>00:17</td>\n    </tr>\n    <tr>\n      <td>3</td>\n      <td>0.268090</td>\n      <td>0.115800</td>\n      <td>0.032854</td>\n      <td>00:14</td>\n    </tr>\n  </tbody>\n</table>\n\n\nunderstand structure of model\n\n\n```python\nlearn.summary()\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    Sequential (Input shape: 64 x 3 x 224 x 224)\n    ============================================================================\n    Layer (type)         Output Shape         Param #    Trainable \n    ============================================================================\n                         64 x 64 x 112 x 112 \n    Conv2d                                    9408       True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    ____________________________________________________________________________\n                         64 x 64 x 56 x 56   \n    MaxPool2d                                                      \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ReLU                                                           \n    Conv2d                                    36864      True      \n    BatchNorm2d                               128        True      \n    ____________________________________________________________________________\n                         64 x 128 x 28 x 28  \n    Conv2d                                    73728      True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    8192       True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ReLU                                                           \n    Conv2d                                    147456     True      \n    BatchNorm2d                               256        True      \n    ____________________________________________________________________________\n                         64 x 256 x 14 x 14  \n    Conv2d                                    294912     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    32768      True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ReLU                                                           \n    Conv2d                                    589824     True      \n    BatchNorm2d                               512        True      \n    ____________________________________________________________________________\n                         64 x 512 x 7 x 7    \n    Conv2d                                    1179648    True      \n    BatchNorm2d                               1024       True      \n    ReLU                                                           \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    Conv2d                                    131072     True      \n    BatchNorm2d                               1024       True      \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    ReLU                                                           \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    ReLU                                                           \n    Conv2d                                    2359296    True      \n    BatchNorm2d                               1024       True      \n    ____________________________________________________________________________\n                         64 x 512 x 1 x 1    \n    AdaptiveAvgPool2d                                              \n    AdaptiveMaxPool2d                                              \n    ____________________________________________________________________________\n                         64 x 1024           \n    Flatten                                                        \n    BatchNorm1d                               2048       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 512            \n    Linear                                    524288     True      \n    ReLU                                                           \n    BatchNorm1d                               1024       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 10             \n    Linear                                    5120       True      \n    ____________________________________________________________________________\n    \n    Total params: 21,817,152\n    Total trainable params: 21,817,152\n    Total non-trainable params: 0\n    \n    Optimizer used: <function Adam at 0x7b5a37dbbeb0>\n    Loss function: FlattenedLoss of CrossEntropyLoss()\n    \n    Model unfrozen\n    \n    Callbacks:\n      - TrainEvalCallback\n      - CastToTensor\n      - Recorder\n      - ProgressCallback\n\n\n\n#### Confusion Metric\n\n\n```python\ninterp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_23_4.png)\n    \n\n\n#### Display Images with highest loss, to Get the picture ðŸ˜Š\n\n\n```python\ninterp.plot_top_losses(6, nrows=2, figsize=(18,4))\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n    \n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_25_2.png)\n    \n\n\nWe can observe from both the confusion matrix and visual representation that the model is having difficulty differentiating between the Jaguar and the African Leopard. Even I find it challenging to distinguish between the two. ðŸ˜µ So, we can let it be.\n\n### 1.4 : Clear the data\n\n\n```python\n#hide_output\ncleaner = ImageClassifierCleaner(learn)\ncleaner\n\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n    VBox(children=(Dropdown(options=('AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS'â€¦\n\n\n#### Apply those changes\n\n\n```python\nfor idx in cleaner.delete(): cleaner.fns[idx].unlink()\nfor idx,cat in cleaner.change(): shutil.move(str(cleaner.fns[idx]), path/cat)\n```\n\n## Level 2 : Understand Computer Vision Architectures\n\n#### [timm](https://timm.fast.ai/)   is a wonderful library by Ross Wightman which provides state-of-the-art pre-trained computer vision models. It's like Huggingface Transformers, but for computer vision instead of NLP.\n\n\n### 2.1 : Download Data\nLet's download Ross's GitHub repository, which is regularly updated with benchmark data for computer vision architectures.\nThese benchmark are created on **Imagenet.**\n\n\n```python\n! git clone --depth 1 https://github.com/rwightman/pytorch-image-models.git\n%cd pytorch-image-models/results\n```\n\n    Cloning into 'pytorch-image-models'...\n    remote: Enumerating objects: 572, done.[K\n    remote: Counting objects: 100% (572/572), done.[K\n    remote: Compressing objects: 100% (403/403), done.[K\n    remote: Total 572 (delta 222), reused 341 (delta 163), pack-reused 0[K\n    Receiving objects: 100% (572/572), 2.59 MiB | 4.87 MiB/s, done.\n    Resolving deltas: 100% (222/222), done.\n    /content/pytorch-image-models/results/pytorch-image-models/results\n    \n\n\n```python\nimport pandas as pd\n\nBenchmark_Result = pd.read_csv('results-imagenet.csv')\nBenchmark_Result['model_org'] = Benchmark_Result['model']\nBenchmark_Result['model'] = Benchmark_Result['model'].str.split('.').str[0]\nBenchmark_Result.head(5)\n```\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>model</th>\n      <th>top1</th>\n      <th>top1_err</th>\n      <th>top5</th>\n      <th>top5_err</th>\n      <th>param_count</th>\n      <th>img_size</th>\n      <th>crop_pct</th>\n      <th>interpolation</th>\n      <th>model_org</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>eva02_large_patch14_448</td>\n      <td>90.052</td>\n      <td>9.948</td>\n      <td>99.048</td>\n      <td>0.952</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_m38m_ft_in22k_in1k</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>eva02_large_patch14_448</td>\n      <td>89.970</td>\n      <td>10.030</td>\n      <td>99.012</td>\n      <td>0.988</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_in22k_ft_in22k_in1k</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>eva_giant_patch14_560</td>\n      <td>89.786</td>\n      <td>10.214</td>\n      <td>98.992</td>\n      <td>1.008</td>\n      <td>1,014.45</td>\n      <td>560</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva_giant_patch14_560.m30m_ft_in22k_in1k</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>eva02_large_patch14_448</td>\n      <td>89.622</td>\n      <td>10.378</td>\n      <td>98.950</td>\n      <td>1.050</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_in22k_ft_in1k</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>eva02_large_patch14_448</td>\n      <td>89.574</td>\n      <td>10.426</td>\n      <td>98.924</td>\n      <td>1.076</td>\n      <td>305.08</td>\n      <td>448</td>\n      <td>1.0</td>\n      <td>bicubic</td>\n      <td>eva02_large_patch14_448.mim_m38m_ft_in1k</td>\n    </tr>\n  </tbody>\n</table>\n\n\nLet's add a \"family\" column that will allow us to group architectures into categories with similar characteristics:\n\n\n```python\ndef get_data(part, col):\n    df = pd.read_csv(f'benchmark-{part}-amp-nhwc-pt111-cu113-rtx3090.csv').merge(Benchmark_Result, on='model')\n    df['secs'] = 1. / df[col]\n    df['family'] = df.model.str.extract('^([a-z]+?(?:v2)?)(?:\\d|_|$)')\n    df = df[~df.model.str.endswith('gn')]\n    df.loc[df.model.str.contains('in22'),'family'] = df.loc[df.model.str.contains('in22'),'family'] + '_in22'\n    df.loc[df.model.str.contains('resnet.*d'),'family'] = df.loc[df.model.str.contains('resnet.*d'),'family'] + 'd'\n    return df[df.family.str.contains('^re[sg]netd?|beit|convnext|levit|efficient|vit|vgg|swin')]\n\nInference_Data = get_data('infer', 'infer_samples_per_sec')\nInference_Data.head(5)\n```\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>model</th>\n      <th>infer_samples_per_sec</th>\n      <th>infer_step_time</th>\n      <th>infer_batch_size</th>\n      <th>infer_img_size</th>\n      <th>param_count_x</th>\n      <th>top1</th>\n      <th>top1_err</th>\n      <th>top5</th>\n      <th>top5_err</th>\n      <th>param_count_y</th>\n      <th>img_size</th>\n      <th>crop_pct</th>\n      <th>interpolation</th>\n      <th>model_org</th>\n      <th>secs</th>\n      <th>family</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>12</th>\n      <td>levit_128s</td>\n      <td>21485.80</td>\n      <td>47.648</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>7.78</td>\n      <td>76.526</td>\n      <td>23.474</td>\n      <td>92.872</td>\n      <td>7.128</td>\n      <td>7.78</td>\n      <td>224</td>\n      <td>0.900</td>\n      <td>bicubic</td>\n      <td>levit_128s.fb_dist_in1k</td>\n      <td>0.000047</td>\n      <td>levit</td>\n    </tr>\n    <tr>\n      <th>13</th>\n      <td>regnetx_002</td>\n      <td>17821.98</td>\n      <td>57.446</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>2.68</td>\n      <td>68.752</td>\n      <td>31.248</td>\n      <td>88.542</td>\n      <td>11.458</td>\n      <td>2.68</td>\n      <td>224</td>\n      <td>0.875</td>\n      <td>bicubic</td>\n      <td>regnetx_002.pycls_in1k</td>\n      <td>0.000056</td>\n      <td>regnetx</td>\n    </tr>\n    <tr>\n      <th>15</th>\n      <td>regnety_002</td>\n      <td>16673.08</td>\n      <td>61.405</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>3.16</td>\n      <td>70.280</td>\n      <td>29.720</td>\n      <td>89.530</td>\n      <td>10.470</td>\n      <td>3.16</td>\n      <td>224</td>\n      <td>0.875</td>\n      <td>bicubic</td>\n      <td>regnety_002.pycls_in1k</td>\n      <td>0.000060</td>\n      <td>regnety</td>\n    </tr>\n    <tr>\n      <th>17</th>\n      <td>levit_128</td>\n      <td>14657.83</td>\n      <td>69.849</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>9.21</td>\n      <td>78.490</td>\n      <td>21.510</td>\n      <td>94.012</td>\n      <td>5.988</td>\n      <td>9.21</td>\n      <td>224</td>\n      <td>0.900</td>\n      <td>bicubic</td>\n      <td>levit_128.fb_dist_in1k</td>\n      <td>0.000068</td>\n      <td>levit</td>\n    </tr>\n    <tr>\n      <th>18</th>\n      <td>regnetx_004</td>\n      <td>14440.03</td>\n      <td>70.903</td>\n      <td>1024</td>\n      <td>224</td>\n      <td>5.16</td>\n      <td>72.402</td>\n      <td>27.598</td>\n      <td>90.826</td>\n      <td>9.174</td>\n      <td>5.16</td>\n      <td>224</td>\n      <td>0.875</td>\n      <td>bicubic</td>\n      <td>regnetx_004.pycls_in1k</td>\n      <td>0.000069</td>\n      <td>regnetx</td>\n    </tr>\n  </tbody>\n</table>\n\n### 2.2 : Plot of all the architectures.\n\nHere's the results for inference performance (see the last section for training performance). In this chart:\n\n\n*   the x axis shows how many seconds it takes to process one image (note: it's a log scale)\n*  the y axis is the accuracy on Imagenet\n\n*   the size of each bubble is proportional to the size of images used in testing\n*  the color shows what \"family\" the architecture is from.\n\n\nHover your mouse over a marker to see details about the model. Double-click in the legend to display just one family. Single-click in the legend to show or hide a family.\n\n\n\n\n\n\n\n\n\n```python\nimport plotly.express as px\nw,h = 1000,800\n\ndef show_all(Inference_Data, title, size):\n    return px.scatter(Inference_Data, width=w, height=h, size=Inference_Data[size]**2, title=title,\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n\n\n```\n\n\n```python\nshow_all(Inference_Data, 'Inference', 'infer_img_size')\n```\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_2.PNG)\n\n\n### 2.3 : Specific Architectures Plot\nLet's create a plot for selected architectures which we would like to use normally\n\n\n```python\n# Filter data only for convnext, resnet\nkeywords = ['convnext', 'resnet','levit','beit']\n\n# Filter rows based on the exact keywords\nBest_Model_Df = Inference_Data[Inference_Data['family'].isin(keywords)]\n\nshow_all(Best_Model_Df, 'Inference', 'infer_img_size')\n```\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_3.PNG)\n\n\n### 2.4 : Family Connection Plot\n Let's add lines through the points of each family, to help see how they compare -- but note that we can see that a linear fit isn't actually ideal here! It's just there to help visually see the groups.\n\n\n```python\nsubs = 'levit|resnetd?|regnetx|vgg|convnext.*|efficientnetv2|beit|swin'\n\ndef show_subs(Inference_Data, title, size):\n    df_subs = Inference_Data[Inference_Data.family.str.fullmatch(subs)]\n    return px.scatter(df_subs, width=w, height=h, size=df_subs[size]**2, title=title,\n        trendline=\"ols\", trendline_options={'log_x':True},\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n```\n\n\n```python\nshow_subs(Inference_Data, 'Inference', 'infer_img_size')\n```\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_4.PNG)\n\n\n#### We can conclude that `Convnext` can be go to model with decent GPU at our disposal, because it has more accuracy then resenet and it take less time than `beit`\n\n## Level 3 : Build a model using Convnext(basic or tiny)\n\nList of all the basic & tiny version models in `Convnext` and choose the best.\n\n\n```python\n[model for model in timm.list_models('convnext*') if 'base' in model or 'tiny' in model]\n```\n\n\n\n\n    ['convnext_base',\n     'convnext_tiny',\n     'convnext_tiny_hnf',\n     'convnextv2_base',\n     'convnextv2_tiny']\n\n\n\n\n```python\nlearn_conv = vision_learner(dls, convnext_base, metrics=error_rate).to_fp16()\nlearn_conv.fine_tune(5)\n```\n\n    /usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.\n      warnings.warn(\n    /usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ConvNeXt_Base_Weights.IMAGENET1K_V1`. You can also use `weights=ConvNeXt_Base_Weights.DEFAULT` to get the most up-to-date weights.\n      warnings.warn(msg)\n    \n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>1.130588</td>\n      <td>0.183650</td>\n      <td>0.045175</td>\n      <td>00:17</td>\n    </tr>\n  </tbody>\n</table>\n\n\n    /usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n      self.pid = os.fork()\n    /usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n      self.pid = os.fork()\n    \n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: left;\">\n      <th>epoch</th>\n      <th>train_loss</th>\n      <th>valid_loss</th>\n      <th>error_rate</th>\n      <th>time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>0.306945</td>\n      <td>0.164550</td>\n      <td>0.047228</td>\n      <td>00:20</td>\n    </tr>\n    <tr>\n      <td>1</td>\n      <td>0.253462</td>\n      <td>0.118687</td>\n      <td>0.026694</td>\n      <td>00:11</td>\n    </tr>\n    <tr>\n      <td>2</td>\n      <td>0.207020</td>\n      <td>0.103058</td>\n      <td>0.024641</td>\n      <td>00:11</td>\n    </tr>\n    <tr>\n      <td>3</td>\n      <td>0.175618</td>\n      <td>0.094374</td>\n      <td>0.020534</td>\n      <td>00:11</td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>0.151438</td>\n      <td>0.092010</td>\n      <td>0.020534</td>\n      <td>00:13</td>\n    </tr>\n  </tbody>\n</table>\n\nCompared to the `resnet34` model, which had an error rate of 32%, the `convnext_base` model demonstrates a significant improvement with an error rate of just 21%\n\nStructure of the architecture\n\n\n```python\nlearn_conv.summary()\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    Sequential (Input shape: 64 x 3 x 128 x 128)\n    ============================================================================\n    Layer (type)         Output Shape         Param #    Trainable \n    ============================================================================\n                         64 x 128 x 32 x 32  \n    Conv2d                                    6272       True      \n    LayerNorm2d                               256        True      \n    Conv2d                                    6400       True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Permute                                                        \n    LayerNorm                                 256        True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 512  \n    Linear                                    66048      True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Linear                                    65664      True      \n    ____________________________________________________________________________\n                         64 x 128 x 32 x 32  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    6400       True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Permute                                                        \n    LayerNorm                                 256        True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 512  \n    Linear                                    66048      True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Linear                                    65664      True      \n    ____________________________________________________________________________\n                         64 x 128 x 32 x 32  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    6400       True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Permute                                                        \n    LayerNorm                                 256        True      \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 512  \n    Linear                                    66048      True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 32 x 32 x 128  \n    Linear                                    65664      True      \n    ____________________________________________________________________________\n                         64 x 128 x 32 x 32  \n    Permute                                                        \n    StochasticDepth                                                \n    LayerNorm2d                               256        True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Conv2d                                    131328     True      \n    Conv2d                                    12800      True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Permute                                                        \n    LayerNorm                                 512        True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 1024 \n    Linear                                    263168     True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Linear                                    262400     True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    12800      True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Permute                                                        \n    LayerNorm                                 512        True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 1024 \n    Linear                                    263168     True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Linear                                    262400     True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    12800      True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Permute                                                        \n    LayerNorm                                 512        True      \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 1024 \n    Linear                                    263168     True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 16 x 16 x 256  \n    Linear                                    262400     True      \n    ____________________________________________________________________________\n                         64 x 256 x 16 x 16  \n    Permute                                                        \n    StochasticDepth                                                \n    LayerNorm2d                               512        True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Conv2d                                    524800     True      \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    25600      True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Permute                                                        \n    LayerNorm                                 1024       True      \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 2048   \n    Linear                                    1050624    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 8 x 8 x 512    \n    Linear                                    1049088    True      \n    ____________________________________________________________________________\n                         64 x 512 x 8 x 8    \n    Permute                                                        \n    StochasticDepth                                                \n    LayerNorm2d                               1024       True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Conv2d                                    2098176    True      \n    Conv2d                                    51200      True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Permute                                                        \n    LayerNorm                                 2048       True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 4096   \n    Linear                                    4198400    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Linear                                    4195328    True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    51200      True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Permute                                                        \n    LayerNorm                                 2048       True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 4096   \n    Linear                                    4198400    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Linear                                    4195328    True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Permute                                                        \n    StochasticDepth                                                \n    Conv2d                                    51200      True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Permute                                                        \n    LayerNorm                                 2048       True      \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 4096   \n    Linear                                    4198400    True      \n    GELU                                                           \n    ____________________________________________________________________________\n                         64 x 4 x 4 x 1024   \n    Linear                                    4195328    True      \n    ____________________________________________________________________________\n                         64 x 1024 x 4 x 4   \n    Permute                                                        \n    StochasticDepth                                                \n    ____________________________________________________________________________\n                         64 x 1024 x 1 x 1   \n    AdaptiveAvgPool2d                                              \n    AdaptiveMaxPool2d                                              \n    ____________________________________________________________________________\n                         64 x 2048           \n    Flatten                                                        \n    BatchNorm1d                               4096       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 512            \n    Linear                                    1048576    True      \n    ReLU                                                           \n    BatchNorm1d                               1024       True      \n    Dropout                                                        \n    ____________________________________________________________________________\n                         64 x 10             \n    Linear                                    5120       True      \n    ____________________________________________________________________________\n    \n    Total params: 88,605,184\n    Total trainable params: 88,605,184\n    Total non-trainable params: 0\n    \n    Optimizer used: <function Adam at 0x7b5a37dbbeb0>\n    Loss function: FlattenedLoss of CrossEntropyLoss()\n    \n    Model unfrozen\n    \n    Callbacks:\n      - TrainEvalCallback\n      - CastToTensor\n      - MixedPrecision\n      - Recorder\n      - ProgressCallback\n\n\n\nLet's downlod the model for future reference\n\n\n```python\nlearn_conv.export('Big_Cat_Convnext_Model.pkl')\n#learn_conv.export('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n## Level 4. Test the Model\n\n\nLet's test the model with an image\n\n\n```python\nfrom fastai.vision.all import *\nimport gradio as gr\n```\n\n\n```python\nim = PILImage.create('/content/drive/MyDrive/Colab Notebooks/FastAI Course/SnowLeopard.jpg')\nim.thumbnail((224,224))\nim\n```\n\n\n\n\n    \n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_59_0.png)\n    \n\n\n\n\n```python\nlearn_conv = load_learner('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n\n```python\nlearn_conv.predict(im)\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    ('CHEETAH',\n     tensor(2),\n     tensor([1.0988e-04, 8.7617e-05, 9.2564e-01, 2.9294e-06, 1.2592e-06, 1.6162e-06,\n             2.6748e-02, 6.5111e-07, 4.7398e-02, 7.3348e-06]))\n\n\n\n\n```python\nlearn_conv.dls.vocab\n```\n\n\n\n\n    ['AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS', 'OCELOT', 'PUMA', 'SNOW LEOPARD', 'TIGER']\n\n\n\n\n```python\ncategories = learn_conv.dls.vocab\n\npred, idx, probs = learn_conv.predict(im)\nresult = dict(zip(categories, map(float,probs)))\nresult\n```\n\n\n\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n\n\n\n\n\n\n\n\n\n\n    {'AFRICAN LEOPARD': 0.00010988322173943743,\n     'CARACAL': 8.761714707361534e-05,\n     'CHEETAH': 0.9256432056427002,\n     'CLOUDED LEOPARD': 2.929433776444057e-06,\n     'JAGUAR': 1.2592141729328432e-06,\n     'LIONS': 1.6162448446266353e-06,\n     'OCELOT': 0.026747871190309525,\n     'PUMA': 6.511066317216319e-07,\n     'SNOW LEOPARD': 0.04739758372306824,\n     'TIGER': 7.334848760365276e-06}\n\n\n\nTop 3 Predicted Cat Names with Highest Probability\"\n\n\n```python\nsorted_result = dict(sorted(result.items(), key=lambda item: item[1], reverse=True))\ntop_classes = list(sorted_result.keys())[:3]\ntop_classes\n```\n\n\n\n\n    ['CHEETAH', 'SNOW LEOPARD', 'OCELOT']\n\n\n\nSo our model predicted `CHEETAH` with probablity of 93%"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","editor":"visual","theme":{"light":"flatly","dark":"solar"},"title-block-banner":true,"title":"FastAI Course Lecture 3 Notes","author":"Kanav Sharma","date":"2024-04-14","categories":["Computer Vision","FastAI"],"order":0},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}