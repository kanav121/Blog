{"title":"FastAI Course Lecture 3 Notes","markdown":{"yaml":{"title":"FastAI Course Lecture 3 Notes","author":"Kanav Sharma","date":"2024-04-14","categories":["Computer Vision","FastAI"],"toc":true,"title-block-banner":true,"order":0},"headingText":"This code aims to upscale our last lession.","containsRefs":false,"markdown":"\n\n\nPreviously, we obtained our data from the DuckDuckGo API and built our model around that.\n\nThis time, we will retrieve data from a Kaggle dataset, enhance our model, improve our understanding of different available pre-trained vision architectures in PyTorch using the `timm` library, and implement another model according to our requirements.\n\n## Level 1 : Repeat last lesson\n\n### 1.1 : Download dataset from Kaggle\n\n``` python\nfrom google.colab import files\n\n# Upload the Kaggle API key JSON file\nuploaded = files.upload()\n\n!pip install kaggle\n\n!mkdir -p ~/.kaggle\n!mv kaggle.json ~/.kaggle/\n!chmod 600 ~/.kaggle/kaggle.json\n```\n\n```         \nSaving kaggle.json to kaggle.json\nRequirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)\nRequirement already satisfied: six>=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)\nRequirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2024.2.2)\nRequirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)\nRequirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)\nRequirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.2)\nRequirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.4)\nRequirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)\nRequirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)\nRequirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach->kaggle) (0.5.1)\nRequirement already satisfied: text-unidecode>=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify->kaggle) (1.3)\nRequirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.3.2)\nRequirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.6)\n```\n\n#### Download dataset :\n\nOpen dataset in Kaggle, click on 3 vertical dots (ellipsis) then click on Copy API comamnd, and we are good to go.\n\n``` python\n!kaggle datasets download -d gpiosenka/cats-in-the-wild-image-classification\n\n# Create a folder called \"Big Cat\"\n!mkdir -p Big_Cat\n\n# Unzip the dataset into the \"Big Cat\" folder\n!unzip cats-in-the-wild-image-classification.zip -d Big_Cat\n\n# Remove the zip file\n!rm cats-in-the-wild-image-classification.zip\n```\n\n```         \nDownloading cats-in-the-wild-image-classification.zip to /content\n 96% 118M/123M [00:01<00:00, 57.4MB/s]\n100% 123M/123M [00:01<00:00, 65.0MB/s]\nArchive:  cats-in-the-wild-image-classification.zip\n  inflating: Big_Cat/EfficientNetB0-10-(224 X 224)-100.00.h5  \n  inflating: Big_Cat/MobileNetV3 small-10-(224 X 224)-95.96.h5  \n  inflating: Big_Cat/WILDCATS.CSV    \n  inflating: Big_Cat/test/AFRICAN LEOPARD/1.jpg  \n  inflating: Big_Cat/test/AFRICAN LEOPARD/5.jpg  \n  inflating: Big_Cat/test/CARACAL/1.jpg  \n  inflating: Big_Cat/test/CARACAL/5.jpg  \n  inflating: Big_Cat/test/CHEETAH/1.jpg  \n  inflating: Big_Cat/test/CHEETAH/5.jpg  \n  inflating: Big_Cat/test/CLOUDED LEOPARD/1.jpg  \n  inflating: Big_Cat/test/CLOUDED LEOPARD/5.jpg  \n  inflating: Big_Cat/test/JAGUAR/1.jpg  \n  inflating: Big_Cat/test/JAGUAR/5.jpg  \n  inflating: Big_Cat/test/LIONS/1.jpg  \n  inflating: Big_Cat/test/LIONS/5.jpg  \n  inflating: Big_Cat/test/OCELOT/1.jpg  \n  inflating: Big_Cat/test/OCELOT/5.jpg  \n  inflating: Big_Cat/test/PUMA/1.jpg  \n  inflating: Big_Cat/test/PUMA/5.jpg  \n  inflating: Big_Cat/test/SNOW LEOPARD/1.jpg  \n  inflating: Big_Cat/test/SNOW LEOPARD/5.jpg  \n  inflating: Big_Cat/test/TIGER/1.jpg  \n  inflating: Big_Cat/test/TIGER/5.jpg  \n  inflating: Big_Cat/train/AFRICAN LEOPARD/001.jpg  \n  inflating: Big_Cat/train/AFRICAN LEOPARD/236.jpg  \n  inflating: Big_Cat/train/CARACAL/001.jpg  \n  inflating: Big_Cat/train/CARACAL/236.jpg  \n  inflating: Big_Cat/train/CHEETAH/001.jpg  \n  inflating: Big_Cat/train/CHEETAH/235.jpg  \n  inflating: Big_Cat/train/CLOUDED LEOPARD/001.jpg  \n  inflating: Big_Cat/train/CLOUDED LEOPARD/229.jpg  \n  inflating: Big_Cat/train/JAGUAR/001.jpg  \n  inflating: Big_Cat/train/JAGUAR/238.jpg  \n  inflating: Big_Cat/train/LIONS/001.jpg  \n  inflating: Big_Cat/train/LIONS/228.jpg  \n  inflating: Big_Cat/train/OCELOT/001.jpg  \n  inflating: Big_Cat/train/OCELOT/233.jpg  \n  inflating: Big_Cat/train/PUMA/001.jpg  \n  inflating: Big_Cat/train/PUMA/236.jpg  \n  inflating: Big_Cat/train/SNOW LEOPARD/001.jpg  \n  inflating: Big_Cat/train/SNOW LEOPARD/231.jpg  \n  inflating: Big_Cat/train/TIGER/001.jpg  \n  inflating: Big_Cat/train/TIGER/237.jpg  \n  inflating: Big_Cat/valid/AFRICAN LEOPARD/1.jpg  \n  inflating: Big_Cat/valid/AFRICAN LEOPARD/5.jpg  \n  inflating: Big_Cat/valid/CARACAL/1.jpg\n  inflating: Big_Cat/valid/CARACAL/5.jpg  \n  inflating: Big_Cat/valid/CHEETAH/1.jpg  \n  inflating: Big_Cat/valid/CHEETAH/5.jpg  \n  inflating: Big_Cat/valid/CLOUDED LEOPARD/1.jpg  \n  inflating: Big_Cat/valid/CLOUDED LEOPARD/5.jpg  \n  inflating: Big_Cat/valid/JAGUAR/1.jpg  \n  inflating: Big_Cat/valid/JAGUAR/5.jpg  \n  inflating: Big_Cat/valid/LIONS/1.jpg  \n  inflating: Big_Cat/valid/LIONS/5.jpg  \n  inflating: Big_Cat/valid/OCELOT/1.jpg  \n  inflating: Big_Cat/valid/OCELOT/5.jpg  \n  inflating: Big_Cat/valid/PUMA/1.jpg  \n  inflating: Big_Cat/valid/PUMA/5.jpg  \n  inflating: Big_Cat/valid/SNOW LEOPARD/1.jpg  \n  inflating: Big_Cat/valid/SNOW LEOPARD/5.jpg  \n  inflating: Big_Cat/valid/TIGER/1.jpg  \n  inflating: Big_Cat/valid/TIGER/5.jpg  \n```\n\n#### Remove all files with the \".h5\" extension and move images from the \"valid\" folder to their corresponding subfolders in the \"train\" folder\n\n``` python\nimport os\nimport shutil\n\n# Define the absolute paths of main, train and valid folders\nbig_cat_folder = '/content/Big_Cat/'\ntrain_folder = '/content/Big_Cat/train'\nvalid_folder = '/content/Big_Cat/valid'\n\n# Remove all files with \".h5\" extension\n!find {big_cat_folder} -type f -name '*.h5' -delete\n\n# Create a dictionary to track image counts\nimage_counts = {}\n\n# Get a list of subfolders in the train folder\ntrain_subfolders = [f.path for f in os.scandir(train_folder) if f.is_dir()]\n\n# Get a list of subfolders in the valid folder\nvalid_subfolders = [f.path for f in os.scandir(valid_folder) if f.is_dir()]\n\n# Move images from valid to their corresponding subfolders in train\nfor subfolder in valid_subfolders:\n    class_name = os.path.basename(subfolder)\n    train_subfolder = os.path.join(train_folder, class_name)\n\n    # Create the train subfolder if it doesn't exist\n    if not os.path.exists(train_subfolder):\n        os.makedirs(train_subfolder)\n\n    # Initialize counts in the dictionary\n    image_counts[f\"{class_name}_VALID\"] = len(os.listdir(subfolder))\n\n    # Move images from valid to train subfolder and update counts\n    for file in os.listdir(subfolder):\n        file_path = os.path.join(subfolder, file)\n        dest_path = os.path.join(train_subfolder, file)\n        shutil.move(file_path, dest_path)\n\n\n# Remove the empty valid subfolders\nfor subfolder in valid_subfolders:\n    os.rmdir(subfolder)\n\n# Get count of images in train folder so that we can understand on how much we are training\nfor subfolder in train_subfolders:\n    class_name = os.path.basename(subfolder)\n    image_counts[f\"{class_name}_TRAIN\"] = len(os.listdir(subfolder))\n\nsorted_image_counts = dict(sorted(image_counts.items()))\n\n# Print the sorted image counts dictionary\nprint(\"Sorted Image Counts:\")\nfor key, value in sorted_image_counts.items():\n    print(f\"{key}: {value}\")\n```\n\n```         \nSorted Image Counts:\nAFRICAN LEOPARD_TRAIN: 241\nAFRICAN LEOPARD_VALID: 5\nCARACAL_TRAIN: 241\nCARACAL_VALID: 5\nCHEETAH_TRAIN: 240\nCHEETAH_VALID: 5\nCLOUDED LEOPARD_TRAIN: 234\nCLOUDED LEOPARD_VALID: 5\nJAGUAR_TRAIN: 243\nJAGUAR_VALID: 5\nLIONS_TRAIN: 233\nLIONS_VALID: 5\nOCELOT_TRAIN: 238\nOCELOT_VALID: 5\nPUMA_TRAIN: 241\nPUMA_VALID: 5\nSNOW LEOPARD_TRAIN: 236\nSNOW LEOPARD_VALID: 5\nTIGER_TRAIN: 242\nTIGER_VALID: 5\n```\n\n#### Install latest FastAI Version\n\n``` python\n#hide\n! [ -e /content ] && pip install -Uqq fastbook\n! pip install timm\n\nimport fastbook\nfastbook.setup_book()\nimport timm\n\n#hide\nfrom fastbook import *\nfrom fastai.vision.widgets import *\nfrom fastai.vision.all import *\n```\n\n```         \n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m719.8/719.8 kB[0m [31m7.1 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m510.5/510.5 kB[0m [31m11.6 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m116.3/116.3 kB[0m [31m13.7 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m194.1/194.1 kB[0m [31m2.0 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m134.8/134.8 kB[0m [31m12.0 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m1.6/1.6 MB[0m [31m19.3 MB/s[0m eta [36m0:00:00[0m\n[?25hCollecting timm\n  Downloading timm-0.9.16-py3-none-any.whl (2.2 MB)\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m2.2/2.2 MB[0m [31m15.2 MB/s[0m eta [36m0:00:00[0m\n[?25hRequirement already satisfied: torch in /usr/local/lib/python3.10/dist-packages (from timm) (2.2.1+cu121)\nRequirement already satisfied: torchvision in /usr/local/lib/python3.10/dist-packages (from timm) (0.17.1+cu121)\nRequirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from timm) (6.0.1)\nRequirement already satisfied: huggingface_hub in /usr/local/lib/python3.10/dist-packages (from timm) (0.20.3)\nRequirement already satisfied: safetensors in /usr/local/lib/python3.10/dist-packages (from timm) (0.4.2)\nRequirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (3.13.3)\nRequirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2023.6.0)\nRequirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2.31.0)\nRequirement already satisfied: tqdm>=4.42.1 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.66.2)\nRequirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.10.0)\nRequirement already satisfied: packaging>=20.9 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (24.0)\nRequirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch->timm) (1.12)\nRequirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.2.1)\nRequirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.1.3)\nRequirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: nvidia-cudnn-cu12==8.9.2.26 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (8.9.2.26)\nRequirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.3.1)\nRequirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.0.2.54)\nRequirement already satisfied: nvidia-curand-cu12==10.3.2.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (10.3.2.106)\nRequirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.4.5.107)\nRequirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.0.106)\nRequirement already satisfied: nvidia-nccl-cu12==2.19.3 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.19.3)\nRequirement already satisfied: nvidia-nvtx-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: triton==2.2.0 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.2.0)\nRequirement already satisfied: nvidia-nvjitlink-cu12 in /usr/local/lib/python3.10/dist-packages (from nvidia-cusolver-cu12==11.4.5.107->torch->timm) (12.4.127)\nRequirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (1.25.2)\nRequirement already satisfied: pillow!=8.3.*,>=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (9.4.0)\nRequirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->torch->timm) (2.1.5)\nRequirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.3.2)\nRequirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.6)\nRequirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2.0.7)\nRequirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2024.2.2)\nRequirement already satisfied: mpmath>=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy->torch->timm) (1.3.0)\nInstalling collected packages: timm\nSuccessfully installed timm-0.9.16\nMounted at /content/gdrive\n```\n\n`verify_images()` will return path of images which are corrupt and using `unlink` we can remove these files.\n\n``` python\npath = Path('Big_Cat')\n\nfns = get_image_files(path)\ntotal_imagelength = len(fns)\nfailed = verify_images(fns)\nfailed_imagelength = len(failed)\n\nfailed.map(Path.unlink)\nImage_Count_Dict = {\"Total_Image_Count\": total_imagelength, \"Failed_Image_Count\": failed_imagelength}\nImage_Count_Dict\n```\n\n```         \n/usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n  self.pid = os.fork()\n\n\n\n\n\n{'Total_Image_Count': 2439, 'Failed_Image_Count': 0}\n```\n\nWe have good chunk of images to be trained on\n\n### 1.2 : Prepare data for model training (Data Loaders, Data Augmentaion, etc.).\n\n#### Data Loaders\n\n``` python\nbig_cat = DataBlock(\n    blocks=(ImageBlock, CategoryBlock),\n    get_items=get_image_files,\n    splitter=RandomSplitter(valid_pct=0.2, seed=42),\n    get_y=parent_label,\n    item_tfms=Resize(128))\ndls = big_cat.dataloaders(path)\n\ndls.valid.show_batch(max_n=8, nrows=2)\n```\n\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_15_0.png)\n\n#### Data Augmentation\n\n``` python\nbig_cat = big_cat.new(\n    item_tfms=RandomResizedCrop(224, min_scale=0.5),\n    batch_tfms=aug_transforms())\nbig_cat_dls = big_cat.dataloaders(path)\nbig_cat_dls.train.show_batch(max_n=8, nrows=2)\n```\n\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_17_0.png)\n\n### 1.3 : Train Model\n\n``` python\nlearn = vision_learner(big_cat_dls, resnet34, metrics=error_rate)\nlearn.fine_tune(5)\n```\n\n```         \nDownloading: \"https://download.pytorch.org/models/resnet34-b627a593.pth\" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth\n100%|██████████| 83.3M/83.3M [00:00<00:00, 164MB/s]\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 1.837715   | 0.237122   | 0.088296   | 00:13 |\n+-------+------------+------------+------------+-------+\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 0.565063   | 0.141556   | 0.041068   | 00:18 |\n+-------+------------+------------+------------+-------+\n| 1     | 0.431256   | 0.147855   | 0.051335   | 00:20 |\n+-------+------------+------------+------------+-------+\n| 2     | 0.337753   | 0.119496   | 0.036961   | 00:17 |\n+-------+------------+------------+------------+-------+\n| 3     | 0.268090   | 0.115800   | 0.032854   | 00:14 |\n+-------+------------+------------+------------+-------+\n\nunderstand structure of model\n\n``` python\nlearn.summary()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \nSequential (Input shape: 64 x 3 x 224 x 224)\n============================================================================\nLayer (type)         Output Shape         Param #    Trainable \n============================================================================\n                     64 x 64 x 112 x 112 \nConv2d                                    9408       True      \nBatchNorm2d                               128        True      \nReLU                                                           \n____________________________________________________________________________\n                     64 x 64 x 56 x 56   \nMaxPool2d                                                      \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nReLU                                                           \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nReLU                                                           \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nReLU                                                           \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \n____________________________________________________________________________\n                     64 x 128 x 28 x 28  \nConv2d                                    73728      True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nConv2d                                    8192       True      \nBatchNorm2d                               256        True      \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \n____________________________________________________________________________\n                     64 x 256 x 14 x 14  \nConv2d                                    294912     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    32768      True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \n____________________________________________________________________________\n                     64 x 512 x 7 x 7    \nConv2d                                    1179648    True      \nBatchNorm2d                               1024       True      \nReLU                                                           \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nConv2d                                    131072     True      \nBatchNorm2d                               1024       True      \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nReLU                                                           \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nReLU                                                           \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \n____________________________________________________________________________\n                     64 x 512 x 1 x 1    \nAdaptiveAvgPool2d                                              \nAdaptiveMaxPool2d                                              \n____________________________________________________________________________\n                     64 x 1024           \nFlatten                                                        \nBatchNorm1d                               2048       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 512            \nLinear                                    524288     True      \nReLU                                                           \nBatchNorm1d                               1024       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 10             \nLinear                                    5120       True      \n____________________________________________________________________________\n\nTotal params: 21,817,152\nTotal trainable params: 21,817,152\nTotal non-trainable params: 0\n\nOptimizer used: <function Adam at 0x7b5a37dbbeb0>\nLoss function: FlattenedLoss of CrossEntropyLoss()\n\nModel unfrozen\n\nCallbacks:\n  - TrainEvalCallback\n  - CastToTensor\n  - Recorder\n  - ProgressCallback\n```\n\n#### Confusion Metric\n\n``` python\ninterp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_23_4.png)\n\n#### Display Images with highest loss, to Get the picture 😊\n\n``` python\ninterp.plot_top_losses(6, nrows=2, figsize=(18,4))\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_25_2.png)\n\nWe can observe from both the confusion matrix and visual representation that the model is having difficulty differentiating between the Jaguar and the African Leopard. Even I find it challenging to distinguish between the two. 😵 So, we can let it be.\n\n### 1.4 : Clear the data\n\n``` python\n#hide_output\ncleaner = ImageClassifierCleaner(learn)\ncleaner\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \nVBox(children=(Dropdown(options=('AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS'…\n```\n\n#### Apply those changes\n\n``` python\nfor idx in cleaner.delete(): cleaner.fns[idx].unlink()\nfor idx,cat in cleaner.change(): shutil.move(str(cleaner.fns[idx]), path/cat)\n```\n\n## Level 2 : Understand Computer Vision Architectures\n\n#### [timm](https://timm.fast.ai/) is a wonderful library by Ross Wightman which provides state-of-the-art pre-trained computer vision models. It's like Huggingface Transformers, but for computer vision instead of NLP.\n\n### 2.1 : Download Data\n\nLet's download Ross's GitHub repository, which is regularly updated with benchmark data for computer vision architectures. These benchmark are created on **Imagenet.**\n\n``` python\n! git clone --depth 1 https://github.com/rwightman/pytorch-image-models.git\n%cd pytorch-image-models/results\n```\n\n```         \nCloning into 'pytorch-image-models'...\nremote: Enumerating objects: 572, done.[K\nremote: Counting objects: 100% (572/572), done.[K\nremote: Compressing objects: 100% (403/403), done.[K\nremote: Total 572 (delta 222), reused 341 (delta 163), pack-reused 0[K\nReceiving objects: 100% (572/572), 2.59 MiB | 4.87 MiB/s, done.\nResolving deltas: 100% (222/222), done.\n/content/pytorch-image-models/results/pytorch-image-models/results\n```\n\n``` python\nimport pandas as pd\n\nBenchmark_Result = pd.read_csv('results-imagenet.csv')\nBenchmark_Result['model_org'] = Benchmark_Result['model']\nBenchmark_Result['model'] = Benchmark_Result['model'].str.split('.').str[0]\nBenchmark_Result.head(5)\n```\n\n<table>\n<thead>\n<tr class=\"header\">\n<th><p></p></th>\n<th><p>model</p></th>\n<th><p>top1</p></th>\n<th><p>top1_err</p></th>\n<th><p>top5</p></th>\n<th><p>top5_err</p></th>\n<th><p>param_count</p></th>\n<th><p>img_size</p></th>\n<th><p>crop_pct</p></th>\n<th><p>interpolation</p></th>\n<th><p>model_org</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>0</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>90.052</p></td>\n<td><p>9.948</p></td>\n<td><p>99.048</p></td>\n<td><p>0.952</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_m38m_ft_in22k_in1k</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>1</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>89.970</p></td>\n<td><p>10.030</p></td>\n<td><p>99.012</p></td>\n<td><p>0.988</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_in22k_ft_in22k_in1k</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>2</p></td>\n<td><p>eva_giant_patch14_560</p></td>\n<td><p>89.786</p></td>\n<td><p>10.214</p></td>\n<td><p>98.992</p></td>\n<td><p>1.008</p></td>\n<td><p>1,014.45</p></td>\n<td><p>560</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva_giant_patch14_560.m30m_ft_in22k_in1k</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>3</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>89.622</p></td>\n<td><p>10.378</p></td>\n<td><p>98.950</p></td>\n<td><p>1.050</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_in22k_ft_in1k</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>4</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>89.574</p></td>\n<td><p>10.426</p></td>\n<td><p>98.924</p></td>\n<td><p>1.076</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_m38m_ft_in1k</p></td>\n</tr>\n</tbody>\n</table>\n\nLet's add a \"family\" column that will allow us to group architectures into categories with similar characteristics:\n\n``` python\ndef get_data(part, col):\n    df = pd.read_csv(f'benchmark-{part}-amp-nhwc-pt111-cu113-rtx3090.csv').merge(Benchmark_Result, on='model')\n    df['secs'] = 1. / df[col]\n    df['family'] = df.model.str.extract('^([a-z]+?(?:v2)?)(?:\\d|_|$)')\n    df = df[~df.model.str.endswith('gn')]\n    df.loc[df.model.str.contains('in22'),'family'] = df.loc[df.model.str.contains('in22'),'family'] + '_in22'\n    df.loc[df.model.str.contains('resnet.*d'),'family'] = df.loc[df.model.str.contains('resnet.*d'),'family'] + 'd'\n    return df[df.family.str.contains('^re[sg]netd?|beit|convnext|levit|efficient|vit|vgg|swin')]\n\nInference_Data = get_data('infer', 'infer_samples_per_sec')\nInference_Data.head(5)\n```\n\n<table>\n<thead>\n<tr class=\"header\">\n<th><p></p></th>\n<th><p>model</p></th>\n<th><p>infer_samples_per_sec</p></th>\n<th><p>infer_step_time</p></th>\n<th><p>infer_batch_size</p></th>\n<th><p>infer_img_size</p></th>\n<th><p>param_count_x</p></th>\n<th><p>top1</p></th>\n<th><p>top1_err</p></th>\n<th><p>top5</p></th>\n<th><p>top5_err</p></th>\n<th><p>param_count_y</p></th>\n<th><p>img_size</p></th>\n<th><p>crop_pct</p></th>\n<th><p>interpolation</p></th>\n<th><p>model_org</p></th>\n<th><p>secs</p></th>\n<th><p>family</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>12</p></td>\n<td><p>levit_128s</p></td>\n<td><p>21485.80</p></td>\n<td><p>47.648</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>7.78</p></td>\n<td><p>76.526</p></td>\n<td><p>23.474</p></td>\n<td><p>92.872</p></td>\n<td><p>7.128</p></td>\n<td><p>7.78</p></td>\n<td><p>224</p></td>\n<td><p>0.900</p></td>\n<td><p>bicubic</p></td>\n<td><p>levit_128s.fb_dist_in1k</p></td>\n<td><p>0.000047</p></td>\n<td><p>levit</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>13</p></td>\n<td><p>regnetx_002</p></td>\n<td><p>17821.98</p></td>\n<td><p>57.446</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>2.68</p></td>\n<td><p>68.752</p></td>\n<td><p>31.248</p></td>\n<td><p>88.542</p></td>\n<td><p>11.458</p></td>\n<td><p>2.68</p></td>\n<td><p>224</p></td>\n<td><p>0.875</p></td>\n<td><p>bicubic</p></td>\n<td><p>regnetx_002.pycls_in1k</p></td>\n<td><p>0.000056</p></td>\n<td><p>regnetx</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>15</p></td>\n<td><p>regnety_002</p></td>\n<td><p>16673.08</p></td>\n<td><p>61.405</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>3.16</p></td>\n<td><p>70.280</p></td>\n<td><p>29.720</p></td>\n<td><p>89.530</p></td>\n<td><p>10.470</p></td>\n<td><p>3.16</p></td>\n<td><p>224</p></td>\n<td><p>0.875</p></td>\n<td><p>bicubic</p></td>\n<td><p>regnety_002.pycls_in1k</p></td>\n<td><p>0.000060</p></td>\n<td><p>regnety</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>17</p></td>\n<td><p>levit_128</p></td>\n<td><p>14657.83</p></td>\n<td><p>69.849</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>9.21</p></td>\n<td><p>78.490</p></td>\n<td><p>21.510</p></td>\n<td><p>94.012</p></td>\n<td><p>5.988</p></td>\n<td><p>9.21</p></td>\n<td><p>224</p></td>\n<td><p>0.900</p></td>\n<td><p>bicubic</p></td>\n<td><p>levit_128.fb_dist_in1k</p></td>\n<td><p>0.000068</p></td>\n<td><p>levit</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>18</p></td>\n<td><p>regnetx_004</p></td>\n<td><p>14440.03</p></td>\n<td><p>70.903</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>5.16</p></td>\n<td><p>72.402</p></td>\n<td><p>27.598</p></td>\n<td><p>90.826</p></td>\n<td><p>9.174</p></td>\n<td><p>5.16</p></td>\n<td><p>224</p></td>\n<td><p>0.875</p></td>\n<td><p>bicubic</p></td>\n<td><p>regnetx_004.pycls_in1k</p></td>\n<td><p>0.000069</p></td>\n<td><p>regnetx</p></td>\n</tr>\n</tbody>\n</table>\n\n### 2.2 : Plot of all the architectures.\n\nHere's the results for inference performance (see the last section for training performance). In this chart:\n\n-   the x axis shows how many seconds it takes to process one image (note: it's a log scale)\n\n-   the y axis is the accuracy on Imagenet\n\n-   the size of each bubble is proportional to the size of images used in testing\n\n-   the color shows what \"family\" the architecture is from.\n\nHover your mouse over a marker to see details about the model. Double-click in the legend to display just one family. Single-click in the legend to show or hide a family.\n\n``` python\nimport plotly.express as px\nw,h = 1000,800\n\ndef show_all(Inference_Data, title, size):\n    return px.scatter(Inference_Data, width=w, height=h, size=Inference_Data[size]**2, title=title,\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n\n```\n\n``` python\nshow_all(Inference_Data, 'Inference', 'infer_img_size')\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_2.PNG)\n\n### 2.3 : Specific Architectures Plot\n\nLet's create a plot for selected architectures which we would like to use normally\n\n``` python\n# Filter data only for convnext, resnet\nkeywords = ['convnext', 'resnet','levit','beit']\n\n# Filter rows based on the exact keywords\nBest_Model_Df = Inference_Data[Inference_Data['family'].isin(keywords)]\n\nshow_all(Best_Model_Df, 'Inference', 'infer_img_size')\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_3.PNG)\n\n### 2.4 : Family Connection Plot\n\nLet's add lines through the points of each family, to help see how they compare -- but note that we can see that a linear fit isn't actually ideal here! It's just there to help visually see the groups.\n\n``` python\nsubs = 'levit|resnetd?|regnetx|vgg|convnext.*|efficientnetv2|beit|swin'\n\ndef show_subs(Inference_Data, title, size):\n    df_subs = Inference_Data[Inference_Data.family.str.fullmatch(subs)]\n    return px.scatter(df_subs, width=w, height=h, size=df_subs[size]**2, title=title,\n        trendline=\"ols\", trendline_options={'log_x':True},\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n```\n\n``` python\nshow_subs(Inference_Data, 'Inference', 'infer_img_size')\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_4.PNG)\n\n#### We can conclude that `Convnext` can be go to model with decent GPU at our disposal, because it has more accuracy then resenet and it take less time than `beit`\n\n## Level 3 : Build a model using Convnext(basic or tiny)\n\nList of all the basic & tiny version models in `Convnext` and choose the best.\n\n``` python\n[model for model in timm.list_models('convnext*') if 'base' in model or 'tiny' in model]\n```\n\n```         \n['convnext_base',\n 'convnext_tiny',\n 'convnext_tiny_hnf',\n 'convnextv2_base',\n 'convnextv2_tiny']\n```\n\n``` python\nlearn_conv = vision_learner(dls, convnext_base, metrics=error_rate).to_fp16()\nlearn_conv.fine_tune(5)\n```\n\n```         \n/usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.\n  warnings.warn(\n/usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ConvNeXt_Base_Weights.IMAGENET1K_V1`. You can also use `weights=ConvNeXt_Base_Weights.DEFAULT` to get the most up-to-date weights.\n  warnings.warn(msg)\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 1.130588   | 0.183650   | 0.045175   | 00:17 |\n+-------+------------+------------+------------+-------+\n\n```         \n/usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n  self.pid = os.fork()\n/usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n  self.pid = os.fork()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 0.306945   | 0.164550   | 0.047228   | 00:20 |\n+-------+------------+------------+------------+-------+\n| 1     | 0.253462   | 0.118687   | 0.026694   | 00:11 |\n+-------+------------+------------+------------+-------+\n| 2     | 0.207020   | 0.103058   | 0.024641   | 00:11 |\n+-------+------------+------------+------------+-------+\n| 3     | 0.175618   | 0.094374   | 0.020534   | 00:11 |\n+-------+------------+------------+------------+-------+\n| 4     | 0.151438   | 0.092010   | 0.020534   | 00:13 |\n+-------+------------+------------+------------+-------+\n\nCompared to the `resnet34` model, which had an error rate of 32%, the `convnext_base` model demonstrates a significant improvement with an error rate of just 21%\n\nStructure of the architecture\n\n``` python\nlearn_conv.summary()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \nSequential (Input shape: 64 x 3 x 128 x 128)\n============================================================================\nLayer (type)         Output Shape         Param #    Trainable \n============================================================================\n                     64 x 128 x 32 x 32  \nConv2d                                    6272       True      \nLayerNorm2d                               256        True      \nConv2d                                    6400       True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nPermute                                                        \nLayerNorm                                 256        True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 512  \nLinear                                    66048      True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nLinear                                    65664      True      \n____________________________________________________________________________\n                     64 x 128 x 32 x 32  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    6400       True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nPermute                                                        \nLayerNorm                                 256        True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 512  \nLinear                                    66048      True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nLinear                                    65664      True      \n____________________________________________________________________________\n                     64 x 128 x 32 x 32  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    6400       True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nPermute                                                        \nLayerNorm                                 256        True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 512  \nLinear                                    66048      True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nLinear                                    65664      True      \n____________________________________________________________________________\n                     64 x 128 x 32 x 32  \nPermute                                                        \nStochasticDepth                                                \nLayerNorm2d                               256        True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nConv2d                                    131328     True      \nConv2d                                    12800      True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nPermute                                                        \nLayerNorm                                 512        True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 1024 \nLinear                                    263168     True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nLinear                                    262400     True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    12800      True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nPermute                                                        \nLayerNorm                                 512        True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 1024 \nLinear                                    263168     True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nLinear                                    262400     True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    12800      True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nPermute                                                        \nLayerNorm                                 512        True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 1024 \nLinear                                    263168     True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nLinear                                    262400     True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nPermute                                                        \nStochasticDepth                                                \nLayerNorm2d                               512        True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nConv2d                                    524800     True      \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nLayerNorm2d                               1024       True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nConv2d                                    2098176    True      \nConv2d                                    51200      True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nPermute                                                        \nLayerNorm                                 2048       True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 4096   \nLinear                                    4198400    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nLinear                                    4195328    True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    51200      True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nPermute                                                        \nLayerNorm                                 2048       True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 4096   \nLinear                                    4198400    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nLinear                                    4195328    True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    51200      True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nPermute                                                        \nLayerNorm                                 2048       True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 4096   \nLinear                                    4198400    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nLinear                                    4195328    True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nPermute                                                        \nStochasticDepth                                                \n____________________________________________________________________________\n                     64 x 1024 x 1 x 1   \nAdaptiveAvgPool2d                                              \nAdaptiveMaxPool2d                                              \n____________________________________________________________________________\n                     64 x 2048           \nFlatten                                                        \nBatchNorm1d                               4096       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 512            \nLinear                                    1048576    True      \nReLU                                                           \nBatchNorm1d                               1024       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 10             \nLinear                                    5120       True      \n____________________________________________________________________________\n\nTotal params: 88,605,184\nTotal trainable params: 88,605,184\nTotal non-trainable params: 0\n\nOptimizer used: <function Adam at 0x7b5a37dbbeb0>\nLoss function: FlattenedLoss of CrossEntropyLoss()\n\nModel unfrozen\n\nCallbacks:\n  - TrainEvalCallback\n  - CastToTensor\n  - MixedPrecision\n  - Recorder\n  - ProgressCallback\n```\n\nLet's downlod the model for future reference\n\n``` python\nlearn_conv.export('Big_Cat_Convnext_Model.pkl')\n#learn_conv.export('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n## Level 4. Test the Model\n\nLet's test the model with an image\n\n``` python\nfrom fastai.vision.all import *\nimport gradio as gr\n```\n\n``` python\nim = PILImage.create('/content/drive/MyDrive/Colab Notebooks/FastAI Course/SnowLeopard.jpg')\nim.thumbnail((224,224))\nim\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_59_0.png)\n\n``` python\nlearn_conv = load_learner('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n``` python\nlearn_conv.predict(im)\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \n('CHEETAH',\n tensor(2),\n tensor([1.0988e-04, 8.7617e-05, 9.2564e-01, 2.9294e-06, 1.2592e-06, 1.6162e-06,\n         2.6748e-02, 6.5111e-07, 4.7398e-02, 7.3348e-06]))\n```\n\n``` python\nlearn_conv.dls.vocab\n```\n\n```         \n['AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS', 'OCELOT', 'PUMA', 'SNOW LEOPARD', 'TIGER']\n```\n\n``` python\ncategories = learn_conv.dls.vocab\n\npred, idx, probs = learn_conv.predict(im)\nresult = dict(zip(categories, map(float,probs)))\nresult\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \n{'AFRICAN LEOPARD': 0.00010988322173943743,\n 'CARACAL': 8.761714707361534e-05,\n 'CHEETAH': 0.9256432056427002,\n 'CLOUDED LEOPARD': 2.929433776444057e-06,\n 'JAGUAR': 1.2592141729328432e-06,\n 'LIONS': 1.6162448446266353e-06,\n 'OCELOT': 0.026747871190309525,\n 'PUMA': 6.511066317216319e-07,\n 'SNOW LEOPARD': 0.04739758372306824,\n 'TIGER': 7.334848760365276e-06}\n```\n\nTop 3 Predicted Cat Names with Highest Probability\"\n\n``` python\nsorted_result = dict(sorted(result.items(), key=lambda item: item[1], reverse=True))\ntop_classes = list(sorted_result.keys())[:3]\ntop_classes\n```\n\n```         \n['CHEETAH', 'SNOW LEOPARD', 'OCELOT']\n```\n\nSo our model predicted `CHEETAH` with probablity of 93%\n","srcMarkdownNoYaml":"\n\n# This code aims to upscale our last lession.\n\nPreviously, we obtained our data from the DuckDuckGo API and built our model around that.\n\nThis time, we will retrieve data from a Kaggle dataset, enhance our model, improve our understanding of different available pre-trained vision architectures in PyTorch using the `timm` library, and implement another model according to our requirements.\n\n## Level 1 : Repeat last lesson\n\n### 1.1 : Download dataset from Kaggle\n\n``` python\nfrom google.colab import files\n\n# Upload the Kaggle API key JSON file\nuploaded = files.upload()\n\n!pip install kaggle\n\n!mkdir -p ~/.kaggle\n!mv kaggle.json ~/.kaggle/\n!chmod 600 ~/.kaggle/kaggle.json\n```\n\n```         \nSaving kaggle.json to kaggle.json\nRequirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)\nRequirement already satisfied: six>=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)\nRequirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2024.2.2)\nRequirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)\nRequirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)\nRequirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.2)\nRequirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.4)\nRequirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)\nRequirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)\nRequirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach->kaggle) (0.5.1)\nRequirement already satisfied: text-unidecode>=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify->kaggle) (1.3)\nRequirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.3.2)\nRequirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->kaggle) (3.6)\n```\n\n#### Download dataset :\n\nOpen dataset in Kaggle, click on 3 vertical dots (ellipsis) then click on Copy API comamnd, and we are good to go.\n\n``` python\n!kaggle datasets download -d gpiosenka/cats-in-the-wild-image-classification\n\n# Create a folder called \"Big Cat\"\n!mkdir -p Big_Cat\n\n# Unzip the dataset into the \"Big Cat\" folder\n!unzip cats-in-the-wild-image-classification.zip -d Big_Cat\n\n# Remove the zip file\n!rm cats-in-the-wild-image-classification.zip\n```\n\n```         \nDownloading cats-in-the-wild-image-classification.zip to /content\n 96% 118M/123M [00:01<00:00, 57.4MB/s]\n100% 123M/123M [00:01<00:00, 65.0MB/s]\nArchive:  cats-in-the-wild-image-classification.zip\n  inflating: Big_Cat/EfficientNetB0-10-(224 X 224)-100.00.h5  \n  inflating: Big_Cat/MobileNetV3 small-10-(224 X 224)-95.96.h5  \n  inflating: Big_Cat/WILDCATS.CSV    \n  inflating: Big_Cat/test/AFRICAN LEOPARD/1.jpg  \n  inflating: Big_Cat/test/AFRICAN LEOPARD/5.jpg  \n  inflating: Big_Cat/test/CARACAL/1.jpg  \n  inflating: Big_Cat/test/CARACAL/5.jpg  \n  inflating: Big_Cat/test/CHEETAH/1.jpg  \n  inflating: Big_Cat/test/CHEETAH/5.jpg  \n  inflating: Big_Cat/test/CLOUDED LEOPARD/1.jpg  \n  inflating: Big_Cat/test/CLOUDED LEOPARD/5.jpg  \n  inflating: Big_Cat/test/JAGUAR/1.jpg  \n  inflating: Big_Cat/test/JAGUAR/5.jpg  \n  inflating: Big_Cat/test/LIONS/1.jpg  \n  inflating: Big_Cat/test/LIONS/5.jpg  \n  inflating: Big_Cat/test/OCELOT/1.jpg  \n  inflating: Big_Cat/test/OCELOT/5.jpg  \n  inflating: Big_Cat/test/PUMA/1.jpg  \n  inflating: Big_Cat/test/PUMA/5.jpg  \n  inflating: Big_Cat/test/SNOW LEOPARD/1.jpg  \n  inflating: Big_Cat/test/SNOW LEOPARD/5.jpg  \n  inflating: Big_Cat/test/TIGER/1.jpg  \n  inflating: Big_Cat/test/TIGER/5.jpg  \n  inflating: Big_Cat/train/AFRICAN LEOPARD/001.jpg  \n  inflating: Big_Cat/train/AFRICAN LEOPARD/236.jpg  \n  inflating: Big_Cat/train/CARACAL/001.jpg  \n  inflating: Big_Cat/train/CARACAL/236.jpg  \n  inflating: Big_Cat/train/CHEETAH/001.jpg  \n  inflating: Big_Cat/train/CHEETAH/235.jpg  \n  inflating: Big_Cat/train/CLOUDED LEOPARD/001.jpg  \n  inflating: Big_Cat/train/CLOUDED LEOPARD/229.jpg  \n  inflating: Big_Cat/train/JAGUAR/001.jpg  \n  inflating: Big_Cat/train/JAGUAR/238.jpg  \n  inflating: Big_Cat/train/LIONS/001.jpg  \n  inflating: Big_Cat/train/LIONS/228.jpg  \n  inflating: Big_Cat/train/OCELOT/001.jpg  \n  inflating: Big_Cat/train/OCELOT/233.jpg  \n  inflating: Big_Cat/train/PUMA/001.jpg  \n  inflating: Big_Cat/train/PUMA/236.jpg  \n  inflating: Big_Cat/train/SNOW LEOPARD/001.jpg  \n  inflating: Big_Cat/train/SNOW LEOPARD/231.jpg  \n  inflating: Big_Cat/train/TIGER/001.jpg  \n  inflating: Big_Cat/train/TIGER/237.jpg  \n  inflating: Big_Cat/valid/AFRICAN LEOPARD/1.jpg  \n  inflating: Big_Cat/valid/AFRICAN LEOPARD/5.jpg  \n  inflating: Big_Cat/valid/CARACAL/1.jpg\n  inflating: Big_Cat/valid/CARACAL/5.jpg  \n  inflating: Big_Cat/valid/CHEETAH/1.jpg  \n  inflating: Big_Cat/valid/CHEETAH/5.jpg  \n  inflating: Big_Cat/valid/CLOUDED LEOPARD/1.jpg  \n  inflating: Big_Cat/valid/CLOUDED LEOPARD/5.jpg  \n  inflating: Big_Cat/valid/JAGUAR/1.jpg  \n  inflating: Big_Cat/valid/JAGUAR/5.jpg  \n  inflating: Big_Cat/valid/LIONS/1.jpg  \n  inflating: Big_Cat/valid/LIONS/5.jpg  \n  inflating: Big_Cat/valid/OCELOT/1.jpg  \n  inflating: Big_Cat/valid/OCELOT/5.jpg  \n  inflating: Big_Cat/valid/PUMA/1.jpg  \n  inflating: Big_Cat/valid/PUMA/5.jpg  \n  inflating: Big_Cat/valid/SNOW LEOPARD/1.jpg  \n  inflating: Big_Cat/valid/SNOW LEOPARD/5.jpg  \n  inflating: Big_Cat/valid/TIGER/1.jpg  \n  inflating: Big_Cat/valid/TIGER/5.jpg  \n```\n\n#### Remove all files with the \".h5\" extension and move images from the \"valid\" folder to their corresponding subfolders in the \"train\" folder\n\n``` python\nimport os\nimport shutil\n\n# Define the absolute paths of main, train and valid folders\nbig_cat_folder = '/content/Big_Cat/'\ntrain_folder = '/content/Big_Cat/train'\nvalid_folder = '/content/Big_Cat/valid'\n\n# Remove all files with \".h5\" extension\n!find {big_cat_folder} -type f -name '*.h5' -delete\n\n# Create a dictionary to track image counts\nimage_counts = {}\n\n# Get a list of subfolders in the train folder\ntrain_subfolders = [f.path for f in os.scandir(train_folder) if f.is_dir()]\n\n# Get a list of subfolders in the valid folder\nvalid_subfolders = [f.path for f in os.scandir(valid_folder) if f.is_dir()]\n\n# Move images from valid to their corresponding subfolders in train\nfor subfolder in valid_subfolders:\n    class_name = os.path.basename(subfolder)\n    train_subfolder = os.path.join(train_folder, class_name)\n\n    # Create the train subfolder if it doesn't exist\n    if not os.path.exists(train_subfolder):\n        os.makedirs(train_subfolder)\n\n    # Initialize counts in the dictionary\n    image_counts[f\"{class_name}_VALID\"] = len(os.listdir(subfolder))\n\n    # Move images from valid to train subfolder and update counts\n    for file in os.listdir(subfolder):\n        file_path = os.path.join(subfolder, file)\n        dest_path = os.path.join(train_subfolder, file)\n        shutil.move(file_path, dest_path)\n\n\n# Remove the empty valid subfolders\nfor subfolder in valid_subfolders:\n    os.rmdir(subfolder)\n\n# Get count of images in train folder so that we can understand on how much we are training\nfor subfolder in train_subfolders:\n    class_name = os.path.basename(subfolder)\n    image_counts[f\"{class_name}_TRAIN\"] = len(os.listdir(subfolder))\n\nsorted_image_counts = dict(sorted(image_counts.items()))\n\n# Print the sorted image counts dictionary\nprint(\"Sorted Image Counts:\")\nfor key, value in sorted_image_counts.items():\n    print(f\"{key}: {value}\")\n```\n\n```         \nSorted Image Counts:\nAFRICAN LEOPARD_TRAIN: 241\nAFRICAN LEOPARD_VALID: 5\nCARACAL_TRAIN: 241\nCARACAL_VALID: 5\nCHEETAH_TRAIN: 240\nCHEETAH_VALID: 5\nCLOUDED LEOPARD_TRAIN: 234\nCLOUDED LEOPARD_VALID: 5\nJAGUAR_TRAIN: 243\nJAGUAR_VALID: 5\nLIONS_TRAIN: 233\nLIONS_VALID: 5\nOCELOT_TRAIN: 238\nOCELOT_VALID: 5\nPUMA_TRAIN: 241\nPUMA_VALID: 5\nSNOW LEOPARD_TRAIN: 236\nSNOW LEOPARD_VALID: 5\nTIGER_TRAIN: 242\nTIGER_VALID: 5\n```\n\n#### Install latest FastAI Version\n\n``` python\n#hide\n! [ -e /content ] && pip install -Uqq fastbook\n! pip install timm\n\nimport fastbook\nfastbook.setup_book()\nimport timm\n\n#hide\nfrom fastbook import *\nfrom fastai.vision.widgets import *\nfrom fastai.vision.all import *\n```\n\n```         \n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m719.8/719.8 kB[0m [31m7.1 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m510.5/510.5 kB[0m [31m11.6 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m116.3/116.3 kB[0m [31m13.7 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m194.1/194.1 kB[0m [31m2.0 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m134.8/134.8 kB[0m [31m12.0 MB/s[0m eta [36m0:00:00[0m\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m1.6/1.6 MB[0m [31m19.3 MB/s[0m eta [36m0:00:00[0m\n[?25hCollecting timm\n  Downloading timm-0.9.16-py3-none-any.whl (2.2 MB)\n[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m2.2/2.2 MB[0m [31m15.2 MB/s[0m eta [36m0:00:00[0m\n[?25hRequirement already satisfied: torch in /usr/local/lib/python3.10/dist-packages (from timm) (2.2.1+cu121)\nRequirement already satisfied: torchvision in /usr/local/lib/python3.10/dist-packages (from timm) (0.17.1+cu121)\nRequirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from timm) (6.0.1)\nRequirement already satisfied: huggingface_hub in /usr/local/lib/python3.10/dist-packages (from timm) (0.20.3)\nRequirement already satisfied: safetensors in /usr/local/lib/python3.10/dist-packages (from timm) (0.4.2)\nRequirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (3.13.3)\nRequirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2023.6.0)\nRequirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (2.31.0)\nRequirement already satisfied: tqdm>=4.42.1 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.66.2)\nRequirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (4.10.0)\nRequirement already satisfied: packaging>=20.9 in /usr/local/lib/python3.10/dist-packages (from huggingface_hub->timm) (24.0)\nRequirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch->timm) (1.12)\nRequirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.2.1)\nRequirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (3.1.3)\nRequirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: nvidia-cudnn-cu12==8.9.2.26 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (8.9.2.26)\nRequirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.3.1)\nRequirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.0.2.54)\nRequirement already satisfied: nvidia-curand-cu12==10.3.2.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (10.3.2.106)\nRequirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (11.4.5.107)\nRequirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.0.106)\nRequirement already satisfied: nvidia-nccl-cu12==2.19.3 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.19.3)\nRequirement already satisfied: nvidia-nvtx-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (12.1.105)\nRequirement already satisfied: triton==2.2.0 in /usr/local/lib/python3.10/dist-packages (from torch->timm) (2.2.0)\nRequirement already satisfied: nvidia-nvjitlink-cu12 in /usr/local/lib/python3.10/dist-packages (from nvidia-cusolver-cu12==11.4.5.107->torch->timm) (12.4.127)\nRequirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (1.25.2)\nRequirement already satisfied: pillow!=8.3.*,>=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision->timm) (9.4.0)\nRequirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->torch->timm) (2.1.5)\nRequirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.3.2)\nRequirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (3.6)\nRequirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2.0.7)\nRequirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->huggingface_hub->timm) (2024.2.2)\nRequirement already satisfied: mpmath>=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy->torch->timm) (1.3.0)\nInstalling collected packages: timm\nSuccessfully installed timm-0.9.16\nMounted at /content/gdrive\n```\n\n`verify_images()` will return path of images which are corrupt and using `unlink` we can remove these files.\n\n``` python\npath = Path('Big_Cat')\n\nfns = get_image_files(path)\ntotal_imagelength = len(fns)\nfailed = verify_images(fns)\nfailed_imagelength = len(failed)\n\nfailed.map(Path.unlink)\nImage_Count_Dict = {\"Total_Image_Count\": total_imagelength, \"Failed_Image_Count\": failed_imagelength}\nImage_Count_Dict\n```\n\n```         \n/usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n  self.pid = os.fork()\n\n\n\n\n\n{'Total_Image_Count': 2439, 'Failed_Image_Count': 0}\n```\n\nWe have good chunk of images to be trained on\n\n### 1.2 : Prepare data for model training (Data Loaders, Data Augmentaion, etc.).\n\n#### Data Loaders\n\n``` python\nbig_cat = DataBlock(\n    blocks=(ImageBlock, CategoryBlock),\n    get_items=get_image_files,\n    splitter=RandomSplitter(valid_pct=0.2, seed=42),\n    get_y=parent_label,\n    item_tfms=Resize(128))\ndls = big_cat.dataloaders(path)\n\ndls.valid.show_batch(max_n=8, nrows=2)\n```\n\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_15_0.png)\n\n#### Data Augmentation\n\n``` python\nbig_cat = big_cat.new(\n    item_tfms=RandomResizedCrop(224, min_scale=0.5),\n    batch_tfms=aug_transforms())\nbig_cat_dls = big_cat.dataloaders(path)\nbig_cat_dls.train.show_batch(max_n=8, nrows=2)\n```\n\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_17_0.png)\n\n### 1.3 : Train Model\n\n``` python\nlearn = vision_learner(big_cat_dls, resnet34, metrics=error_rate)\nlearn.fine_tune(5)\n```\n\n```         \nDownloading: \"https://download.pytorch.org/models/resnet34-b627a593.pth\" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth\n100%|██████████| 83.3M/83.3M [00:00<00:00, 164MB/s]\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 1.837715   | 0.237122   | 0.088296   | 00:13 |\n+-------+------------+------------+------------+-------+\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 0.565063   | 0.141556   | 0.041068   | 00:18 |\n+-------+------------+------------+------------+-------+\n| 1     | 0.431256   | 0.147855   | 0.051335   | 00:20 |\n+-------+------------+------------+------------+-------+\n| 2     | 0.337753   | 0.119496   | 0.036961   | 00:17 |\n+-------+------------+------------+------------+-------+\n| 3     | 0.268090   | 0.115800   | 0.032854   | 00:14 |\n+-------+------------+------------+------------+-------+\n\nunderstand structure of model\n\n``` python\nlearn.summary()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \nSequential (Input shape: 64 x 3 x 224 x 224)\n============================================================================\nLayer (type)         Output Shape         Param #    Trainable \n============================================================================\n                     64 x 64 x 112 x 112 \nConv2d                                    9408       True      \nBatchNorm2d                               128        True      \nReLU                                                           \n____________________________________________________________________________\n                     64 x 64 x 56 x 56   \nMaxPool2d                                                      \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nReLU                                                           \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nReLU                                                           \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \nReLU                                                           \nConv2d                                    36864      True      \nBatchNorm2d                               128        True      \n____________________________________________________________________________\n                     64 x 128 x 28 x 28  \nConv2d                                    73728      True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nConv2d                                    8192       True      \nBatchNorm2d                               256        True      \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \nReLU                                                           \nConv2d                                    147456     True      \nBatchNorm2d                               256        True      \n____________________________________________________________________________\n                     64 x 256 x 14 x 14  \nConv2d                                    294912     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    32768      True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \nReLU                                                           \nConv2d                                    589824     True      \nBatchNorm2d                               512        True      \n____________________________________________________________________________\n                     64 x 512 x 7 x 7    \nConv2d                                    1179648    True      \nBatchNorm2d                               1024       True      \nReLU                                                           \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nConv2d                                    131072     True      \nBatchNorm2d                               1024       True      \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nReLU                                                           \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \nReLU                                                           \nConv2d                                    2359296    True      \nBatchNorm2d                               1024       True      \n____________________________________________________________________________\n                     64 x 512 x 1 x 1    \nAdaptiveAvgPool2d                                              \nAdaptiveMaxPool2d                                              \n____________________________________________________________________________\n                     64 x 1024           \nFlatten                                                        \nBatchNorm1d                               2048       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 512            \nLinear                                    524288     True      \nReLU                                                           \nBatchNorm1d                               1024       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 10             \nLinear                                    5120       True      \n____________________________________________________________________________\n\nTotal params: 21,817,152\nTotal trainable params: 21,817,152\nTotal non-trainable params: 0\n\nOptimizer used: <function Adam at 0x7b5a37dbbeb0>\nLoss function: FlattenedLoss of CrossEntropyLoss()\n\nModel unfrozen\n\nCallbacks:\n  - TrainEvalCallback\n  - CastToTensor\n  - Recorder\n  - ProgressCallback\n```\n\n#### Confusion Metric\n\n``` python\ninterp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_23_4.png)\n\n#### Display Images with highest loss, to Get the picture 😊\n\n``` python\ninterp.plot_top_losses(6, nrows=2, figsize=(18,4))\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n![png](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_25_2.png)\n\nWe can observe from both the confusion matrix and visual representation that the model is having difficulty differentiating between the Jaguar and the African Leopard. Even I find it challenging to distinguish between the two. 😵 So, we can let it be.\n\n### 1.4 : Clear the data\n\n``` python\n#hide_output\ncleaner = ImageClassifierCleaner(learn)\ncleaner\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \nVBox(children=(Dropdown(options=('AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS'…\n```\n\n#### Apply those changes\n\n``` python\nfor idx in cleaner.delete(): cleaner.fns[idx].unlink()\nfor idx,cat in cleaner.change(): shutil.move(str(cleaner.fns[idx]), path/cat)\n```\n\n## Level 2 : Understand Computer Vision Architectures\n\n#### [timm](https://timm.fast.ai/) is a wonderful library by Ross Wightman which provides state-of-the-art pre-trained computer vision models. It's like Huggingface Transformers, but for computer vision instead of NLP.\n\n### 2.1 : Download Data\n\nLet's download Ross's GitHub repository, which is regularly updated with benchmark data for computer vision architectures. These benchmark are created on **Imagenet.**\n\n``` python\n! git clone --depth 1 https://github.com/rwightman/pytorch-image-models.git\n%cd pytorch-image-models/results\n```\n\n```         \nCloning into 'pytorch-image-models'...\nremote: Enumerating objects: 572, done.[K\nremote: Counting objects: 100% (572/572), done.[K\nremote: Compressing objects: 100% (403/403), done.[K\nremote: Total 572 (delta 222), reused 341 (delta 163), pack-reused 0[K\nReceiving objects: 100% (572/572), 2.59 MiB | 4.87 MiB/s, done.\nResolving deltas: 100% (222/222), done.\n/content/pytorch-image-models/results/pytorch-image-models/results\n```\n\n``` python\nimport pandas as pd\n\nBenchmark_Result = pd.read_csv('results-imagenet.csv')\nBenchmark_Result['model_org'] = Benchmark_Result['model']\nBenchmark_Result['model'] = Benchmark_Result['model'].str.split('.').str[0]\nBenchmark_Result.head(5)\n```\n\n<table>\n<thead>\n<tr class=\"header\">\n<th><p></p></th>\n<th><p>model</p></th>\n<th><p>top1</p></th>\n<th><p>top1_err</p></th>\n<th><p>top5</p></th>\n<th><p>top5_err</p></th>\n<th><p>param_count</p></th>\n<th><p>img_size</p></th>\n<th><p>crop_pct</p></th>\n<th><p>interpolation</p></th>\n<th><p>model_org</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>0</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>90.052</p></td>\n<td><p>9.948</p></td>\n<td><p>99.048</p></td>\n<td><p>0.952</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_m38m_ft_in22k_in1k</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>1</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>89.970</p></td>\n<td><p>10.030</p></td>\n<td><p>99.012</p></td>\n<td><p>0.988</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_in22k_ft_in22k_in1k</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>2</p></td>\n<td><p>eva_giant_patch14_560</p></td>\n<td><p>89.786</p></td>\n<td><p>10.214</p></td>\n<td><p>98.992</p></td>\n<td><p>1.008</p></td>\n<td><p>1,014.45</p></td>\n<td><p>560</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva_giant_patch14_560.m30m_ft_in22k_in1k</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>3</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>89.622</p></td>\n<td><p>10.378</p></td>\n<td><p>98.950</p></td>\n<td><p>1.050</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_in22k_ft_in1k</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>4</p></td>\n<td><p>eva02_large_patch14_448</p></td>\n<td><p>89.574</p></td>\n<td><p>10.426</p></td>\n<td><p>98.924</p></td>\n<td><p>1.076</p></td>\n<td><p>305.08</p></td>\n<td><p>448</p></td>\n<td><p>1.0</p></td>\n<td><p>bicubic</p></td>\n<td><p>eva02_large_patch14_448.mim_m38m_ft_in1k</p></td>\n</tr>\n</tbody>\n</table>\n\nLet's add a \"family\" column that will allow us to group architectures into categories with similar characteristics:\n\n``` python\ndef get_data(part, col):\n    df = pd.read_csv(f'benchmark-{part}-amp-nhwc-pt111-cu113-rtx3090.csv').merge(Benchmark_Result, on='model')\n    df['secs'] = 1. / df[col]\n    df['family'] = df.model.str.extract('^([a-z]+?(?:v2)?)(?:\\d|_|$)')\n    df = df[~df.model.str.endswith('gn')]\n    df.loc[df.model.str.contains('in22'),'family'] = df.loc[df.model.str.contains('in22'),'family'] + '_in22'\n    df.loc[df.model.str.contains('resnet.*d'),'family'] = df.loc[df.model.str.contains('resnet.*d'),'family'] + 'd'\n    return df[df.family.str.contains('^re[sg]netd?|beit|convnext|levit|efficient|vit|vgg|swin')]\n\nInference_Data = get_data('infer', 'infer_samples_per_sec')\nInference_Data.head(5)\n```\n\n<table>\n<thead>\n<tr class=\"header\">\n<th><p></p></th>\n<th><p>model</p></th>\n<th><p>infer_samples_per_sec</p></th>\n<th><p>infer_step_time</p></th>\n<th><p>infer_batch_size</p></th>\n<th><p>infer_img_size</p></th>\n<th><p>param_count_x</p></th>\n<th><p>top1</p></th>\n<th><p>top1_err</p></th>\n<th><p>top5</p></th>\n<th><p>top5_err</p></th>\n<th><p>param_count_y</p></th>\n<th><p>img_size</p></th>\n<th><p>crop_pct</p></th>\n<th><p>interpolation</p></th>\n<th><p>model_org</p></th>\n<th><p>secs</p></th>\n<th><p>family</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>12</p></td>\n<td><p>levit_128s</p></td>\n<td><p>21485.80</p></td>\n<td><p>47.648</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>7.78</p></td>\n<td><p>76.526</p></td>\n<td><p>23.474</p></td>\n<td><p>92.872</p></td>\n<td><p>7.128</p></td>\n<td><p>7.78</p></td>\n<td><p>224</p></td>\n<td><p>0.900</p></td>\n<td><p>bicubic</p></td>\n<td><p>levit_128s.fb_dist_in1k</p></td>\n<td><p>0.000047</p></td>\n<td><p>levit</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>13</p></td>\n<td><p>regnetx_002</p></td>\n<td><p>17821.98</p></td>\n<td><p>57.446</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>2.68</p></td>\n<td><p>68.752</p></td>\n<td><p>31.248</p></td>\n<td><p>88.542</p></td>\n<td><p>11.458</p></td>\n<td><p>2.68</p></td>\n<td><p>224</p></td>\n<td><p>0.875</p></td>\n<td><p>bicubic</p></td>\n<td><p>regnetx_002.pycls_in1k</p></td>\n<td><p>0.000056</p></td>\n<td><p>regnetx</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>15</p></td>\n<td><p>regnety_002</p></td>\n<td><p>16673.08</p></td>\n<td><p>61.405</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>3.16</p></td>\n<td><p>70.280</p></td>\n<td><p>29.720</p></td>\n<td><p>89.530</p></td>\n<td><p>10.470</p></td>\n<td><p>3.16</p></td>\n<td><p>224</p></td>\n<td><p>0.875</p></td>\n<td><p>bicubic</p></td>\n<td><p>regnety_002.pycls_in1k</p></td>\n<td><p>0.000060</p></td>\n<td><p>regnety</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>17</p></td>\n<td><p>levit_128</p></td>\n<td><p>14657.83</p></td>\n<td><p>69.849</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>9.21</p></td>\n<td><p>78.490</p></td>\n<td><p>21.510</p></td>\n<td><p>94.012</p></td>\n<td><p>5.988</p></td>\n<td><p>9.21</p></td>\n<td><p>224</p></td>\n<td><p>0.900</p></td>\n<td><p>bicubic</p></td>\n<td><p>levit_128.fb_dist_in1k</p></td>\n<td><p>0.000068</p></td>\n<td><p>levit</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>18</p></td>\n<td><p>regnetx_004</p></td>\n<td><p>14440.03</p></td>\n<td><p>70.903</p></td>\n<td><p>1024</p></td>\n<td><p>224</p></td>\n<td><p>5.16</p></td>\n<td><p>72.402</p></td>\n<td><p>27.598</p></td>\n<td><p>90.826</p></td>\n<td><p>9.174</p></td>\n<td><p>5.16</p></td>\n<td><p>224</p></td>\n<td><p>0.875</p></td>\n<td><p>bicubic</p></td>\n<td><p>regnetx_004.pycls_in1k</p></td>\n<td><p>0.000069</p></td>\n<td><p>regnetx</p></td>\n</tr>\n</tbody>\n</table>\n\n### 2.2 : Plot of all the architectures.\n\nHere's the results for inference performance (see the last section for training performance). In this chart:\n\n-   the x axis shows how many seconds it takes to process one image (note: it's a log scale)\n\n-   the y axis is the accuracy on Imagenet\n\n-   the size of each bubble is proportional to the size of images used in testing\n\n-   the color shows what \"family\" the architecture is from.\n\nHover your mouse over a marker to see details about the model. Double-click in the legend to display just one family. Single-click in the legend to show or hide a family.\n\n``` python\nimport plotly.express as px\nw,h = 1000,800\n\ndef show_all(Inference_Data, title, size):\n    return px.scatter(Inference_Data, width=w, height=h, size=Inference_Data[size]**2, title=title,\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n\n```\n\n``` python\nshow_all(Inference_Data, 'Inference', 'infer_img_size')\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_2.PNG)\n\n### 2.3 : Specific Architectures Plot\n\nLet's create a plot for selected architectures which we would like to use normally\n\n``` python\n# Filter data only for convnext, resnet\nkeywords = ['convnext', 'resnet','levit','beit']\n\n# Filter rows based on the exact keywords\nBest_Model_Df = Inference_Data[Inference_Data['family'].isin(keywords)]\n\nshow_all(Best_Model_Df, 'Inference', 'infer_img_size')\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_3.PNG)\n\n### 2.4 : Family Connection Plot\n\nLet's add lines through the points of each family, to help see how they compare -- but note that we can see that a linear fit isn't actually ideal here! It's just there to help visually see the groups.\n\n``` python\nsubs = 'levit|resnetd?|regnetx|vgg|convnext.*|efficientnetv2|beit|swin'\n\ndef show_subs(Inference_Data, title, size):\n    df_subs = Inference_Data[Inference_Data.family.str.fullmatch(subs)]\n    return px.scatter(df_subs, width=w, height=h, size=df_subs[size]**2, title=title,\n        trendline=\"ols\", trendline_options={'log_x':True},\n        x='secs',  y='top1', log_x=True, color='family', hover_name='model_org', hover_data=[size])\n```\n\n``` python\nshow_subs(Inference_Data, 'Inference', 'infer_img_size')\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_30_4.PNG)\n\n#### We can conclude that `Convnext` can be go to model with decent GPU at our disposal, because it has more accuracy then resenet and it take less time than `beit`\n\n## Level 3 : Build a model using Convnext(basic or tiny)\n\nList of all the basic & tiny version models in `Convnext` and choose the best.\n\n``` python\n[model for model in timm.list_models('convnext*') if 'base' in model or 'tiny' in model]\n```\n\n```         \n['convnext_base',\n 'convnext_tiny',\n 'convnext_tiny_hnf',\n 'convnextv2_base',\n 'convnextv2_tiny']\n```\n\n``` python\nlearn_conv = vision_learner(dls, convnext_base, metrics=error_rate).to_fp16()\nlearn_conv.fine_tune(5)\n```\n\n```         \n/usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.\n  warnings.warn(\n/usr/local/lib/python3.10/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ConvNeXt_Base_Weights.IMAGENET1K_V1`. You can also use `weights=ConvNeXt_Base_Weights.DEFAULT` to get the most up-to-date weights.\n  warnings.warn(msg)\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 1.130588   | 0.183650   | 0.045175   | 00:17 |\n+-------+------------+------------+------------+-------+\n\n```         \n/usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n  self.pid = os.fork()\n/usr/lib/python3.10/multiprocessing/popen_fork.py:66: RuntimeWarning: os.fork() was called. os.fork() is incompatible with multithreaded code, and JAX is multithreaded, so this will likely lead to a deadlock.\n  self.pid = os.fork()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n+-------+------------+------------+------------+-------+\n| epoch | train_loss | valid_loss | error_rate | time  |\n+=======+============+============+============+=======+\n| 0     | 0.306945   | 0.164550   | 0.047228   | 00:20 |\n+-------+------------+------------+------------+-------+\n| 1     | 0.253462   | 0.118687   | 0.026694   | 00:11 |\n+-------+------------+------------+------------+-------+\n| 2     | 0.207020   | 0.103058   | 0.024641   | 00:11 |\n+-------+------------+------------+------------+-------+\n| 3     | 0.175618   | 0.094374   | 0.020534   | 00:11 |\n+-------+------------+------------+------------+-------+\n| 4     | 0.151438   | 0.092010   | 0.020534   | 00:13 |\n+-------+------------+------------+------------+-------+\n\nCompared to the `resnet34` model, which had an error rate of 32%, the `convnext_base` model demonstrates a significant improvement with an error rate of just 21%\n\nStructure of the architecture\n\n``` python\nlearn_conv.summary()\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \nSequential (Input shape: 64 x 3 x 128 x 128)\n============================================================================\nLayer (type)         Output Shape         Param #    Trainable \n============================================================================\n                     64 x 128 x 32 x 32  \nConv2d                                    6272       True      \nLayerNorm2d                               256        True      \nConv2d                                    6400       True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nPermute                                                        \nLayerNorm                                 256        True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 512  \nLinear                                    66048      True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nLinear                                    65664      True      \n____________________________________________________________________________\n                     64 x 128 x 32 x 32  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    6400       True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nPermute                                                        \nLayerNorm                                 256        True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 512  \nLinear                                    66048      True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nLinear                                    65664      True      \n____________________________________________________________________________\n                     64 x 128 x 32 x 32  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    6400       True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nPermute                                                        \nLayerNorm                                 256        True      \n____________________________________________________________________________\n                     64 x 32 x 32 x 512  \nLinear                                    66048      True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 32 x 32 x 128  \nLinear                                    65664      True      \n____________________________________________________________________________\n                     64 x 128 x 32 x 32  \nPermute                                                        \nStochasticDepth                                                \nLayerNorm2d                               256        True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nConv2d                                    131328     True      \nConv2d                                    12800      True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nPermute                                                        \nLayerNorm                                 512        True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 1024 \nLinear                                    263168     True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nLinear                                    262400     True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    12800      True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nPermute                                                        \nLayerNorm                                 512        True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 1024 \nLinear                                    263168     True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nLinear                                    262400     True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    12800      True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nPermute                                                        \nLayerNorm                                 512        True      \n____________________________________________________________________________\n                     64 x 16 x 16 x 1024 \nLinear                                    263168     True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 16 x 16 x 256  \nLinear                                    262400     True      \n____________________________________________________________________________\n                     64 x 256 x 16 x 16  \nPermute                                                        \nStochasticDepth                                                \nLayerNorm2d                               512        True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nConv2d                                    524800     True      \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    25600      True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nPermute                                                        \nLayerNorm                                 1024       True      \n____________________________________________________________________________\n                     64 x 8 x 8 x 2048   \nLinear                                    1050624    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 8 x 8 x 512    \nLinear                                    1049088    True      \n____________________________________________________________________________\n                     64 x 512 x 8 x 8    \nPermute                                                        \nStochasticDepth                                                \nLayerNorm2d                               1024       True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nConv2d                                    2098176    True      \nConv2d                                    51200      True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nPermute                                                        \nLayerNorm                                 2048       True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 4096   \nLinear                                    4198400    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nLinear                                    4195328    True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    51200      True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nPermute                                                        \nLayerNorm                                 2048       True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 4096   \nLinear                                    4198400    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nLinear                                    4195328    True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nPermute                                                        \nStochasticDepth                                                \nConv2d                                    51200      True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nPermute                                                        \nLayerNorm                                 2048       True      \n____________________________________________________________________________\n                     64 x 4 x 4 x 4096   \nLinear                                    4198400    True      \nGELU                                                           \n____________________________________________________________________________\n                     64 x 4 x 4 x 1024   \nLinear                                    4195328    True      \n____________________________________________________________________________\n                     64 x 1024 x 4 x 4   \nPermute                                                        \nStochasticDepth                                                \n____________________________________________________________________________\n                     64 x 1024 x 1 x 1   \nAdaptiveAvgPool2d                                              \nAdaptiveMaxPool2d                                              \n____________________________________________________________________________\n                     64 x 2048           \nFlatten                                                        \nBatchNorm1d                               4096       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 512            \nLinear                                    1048576    True      \nReLU                                                           \nBatchNorm1d                               1024       True      \nDropout                                                        \n____________________________________________________________________________\n                     64 x 10             \nLinear                                    5120       True      \n____________________________________________________________________________\n\nTotal params: 88,605,184\nTotal trainable params: 88,605,184\nTotal non-trainable params: 0\n\nOptimizer used: <function Adam at 0x7b5a37dbbeb0>\nLoss function: FlattenedLoss of CrossEntropyLoss()\n\nModel unfrozen\n\nCallbacks:\n  - TrainEvalCallback\n  - CastToTensor\n  - MixedPrecision\n  - Recorder\n  - ProgressCallback\n```\n\nLet's downlod the model for future reference\n\n``` python\nlearn_conv.export('Big_Cat_Convnext_Model.pkl')\n#learn_conv.export('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n## Level 4. Test the Model\n\nLet's test the model with an image\n\n``` python\nfrom fastai.vision.all import *\nimport gradio as gr\n```\n\n``` python\nim = PILImage.create('/content/drive/MyDrive/Colab Notebooks/FastAI Course/SnowLeopard.jpg')\nim.thumbnail((224,224))\nim\n```\n\n![](Lecture_3_Deployment_Self_files/Lecture_3_Deployment_Self_59_0.png)\n\n``` python\nlearn_conv = load_learner('/content/drive/MyDrive/Colab Notebooks/FastAI Course/Big_Cat_Convnext_Model.pkl')\n```\n\n``` python\nlearn_conv.predict(im)\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \n('CHEETAH',\n tensor(2),\n tensor([1.0988e-04, 8.7617e-05, 9.2564e-01, 2.9294e-06, 1.2592e-06, 1.6162e-06,\n         2.6748e-02, 6.5111e-07, 4.7398e-02, 7.3348e-06]))\n```\n\n``` python\nlearn_conv.dls.vocab\n```\n\n```         \n['AFRICAN LEOPARD', 'CARACAL', 'CHEETAH', 'CLOUDED LEOPARD', 'JAGUAR', 'LIONS', 'OCELOT', 'PUMA', 'SNOW LEOPARD', 'TIGER']\n```\n\n``` python\ncategories = learn_conv.dls.vocab\n\npred, idx, probs = learn_conv.predict(im)\nresult = dict(zip(categories, map(float,probs)))\nresult\n```\n\n```{=html}\n<style>\n    /* Turns off some styling */\n    progress {\n        /* gets rid of default border in Firefox and Opera. */\n        border: none;\n        /* Needs to be in here for Safari polyfill so background images work as expected. */\n        background-size: auto;\n    }\n    progress:not([value]), progress:not([value])::-webkit-progress-bar {\n        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);\n    }\n    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n        background: #F44336;\n    }\n</style>\n```\n```         \n{'AFRICAN LEOPARD': 0.00010988322173943743,\n 'CARACAL': 8.761714707361534e-05,\n 'CHEETAH': 0.9256432056427002,\n 'CLOUDED LEOPARD': 2.929433776444057e-06,\n 'JAGUAR': 1.2592141729328432e-06,\n 'LIONS': 1.6162448446266353e-06,\n 'OCELOT': 0.026747871190309525,\n 'PUMA': 6.511066317216319e-07,\n 'SNOW LEOPARD': 0.04739758372306824,\n 'TIGER': 7.334848760365276e-06}\n```\n\nTop 3 Predicted Cat Names with Highest Probability\"\n\n``` python\nsorted_result = dict(sorted(result.items(), key=lambda item: item[1], reverse=True))\ntop_classes = list(sorted_result.keys())[:3]\ntop_classes\n```\n\n```         \n['CHEETAH', 'SNOW LEOPARD', 'OCELOT']\n```\n\nSo our model predicted `CHEETAH` with probablity of 93%\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","editor":"visual","theme":{"light":"flatly","dark":"solar"},"title-block-banner":true,"title":"FastAI Course Lecture 3 Notes","author":"Kanav Sharma","date":"2024-04-14","categories":["Computer Vision","FastAI"],"order":0},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}